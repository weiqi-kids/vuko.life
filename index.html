<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩÂëºÂê∏ÊãçÈ†ªËôïÁêÜÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .adaptive-mode {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }

        .adaptive-mode h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .adaptive-mode p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .adaptive-mode ul {
            margin: 15px 0;
            padding-left: 25px;
        }

        .adaptive-mode li {
            margin: 8px 0;
            color: #666;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .breathing-monitor {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 30px 0;
        }

        .breath-visual {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }

        .breath-visual h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .breath-circle {
            width: 140px;
            height: 140px;
            border: 5px solid #667eea;
            border-radius: 50%;
            margin: 25px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .breath-circle.breathing {
            animation: breathe 3s infinite ease-in-out;
            border-color: #764ba2;
            color: #764ba2;
        }

        @keyframes breathe {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
            }
            50% { 
                transform: scale(1.15); 
                box-shadow: 0 0 0 20px rgba(102, 126, 234, 0);
            }
        }

        .breath-stats {
            background: rgba(118, 75, 162, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .breath-stats h3 {
            color: #764ba2;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .stat-label {
            font-weight: bold;
            color: #555;
        }

        .stat-value {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .waveform {
            width: 100%;
            height: 120px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 20px 0;
            background: white;
        }

        .status {
            margin: 25px 0;
            padding: 18px;
            border-radius: 12px;
            font-weight: bold;
            text-align: center;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .control-buttons {
            text-align: center;
            margin: 30px 0;
        }

        .config-info {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #667eea;
        }

        .config-info h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            color: #666;
        }

        .config-audio-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin: 25px 0;
        }

        .audio-search-section {
            background: rgba(118, 75, 162, 0.1);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #764ba2;
        }

        .audio-search-section h4 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .device-test-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            width: 100%;
        }

        .device-test-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .music-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .music-item:last-child {
            border-bottom: none;
        }

        .music-item:hover {
            background-color: #f8f9fa;
        }

        .music-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #764ba2;
        }

        .music-info {
            flex: 1;
        }

        .music-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .music-description {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .music-badge {
            background: #764ba2;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .current-selection {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .current-selection-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .current-selection-name {
            color: #333;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .breathing-monitor {
                grid-template-columns: 1fr;
            }
            
            .config-audio-container {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßò Êô∫ËÉΩÂëºÂê∏ÊãçÈ†ªËôïÁêÜÂô®</h1>
        
        <div class="adaptive-mode">
            <h3>ü§ñ Êô∫ËÉΩÂëºÂê∏Áõ£Ê∏¨</h3>
            <p>Á≥ªÁµ±ÊúÉÂç≥ÊôÇÁõ£Ê∏¨‰Ω†ÁöÑÂëºÂê∏ÁãÄÊÖãÔºå‰∏¶Ëá™ÂãïË™øÊï¥ÊãçÈ†ª‰æÜÂºïÂ∞é‰Ω†ÈÄ≤ÂÖ•‰∏çÂêåÁöÑÊÑèË≠òÁãÄÊÖãÔºö</p>
            <ul>
                <li><strong>Ê∑±Â∫¶ÊîæÈ¨Ü</strong> (&lt;10Ê¨°/ÂàÜ)ÔºöDeltaÊ≥¢ 4Hz - Ê∑±Â∫¶ÂÜ•ÊÉ≥Ëàá‰øÆÂæ©</li>
                <li><strong>ÊîæÈ¨ÜÁãÄÊÖã</strong> (10-15Ê¨°/ÂàÜ)ÔºöThetaÊ≥¢ 6Hz - ÂâµÊÑèËàáÁõ¥Ë¶∫</li>
                <li><strong>Ê≠£Â∏∏ÁãÄÊÖã</strong> (15-20Ê¨°/ÂàÜ)ÔºöAlphaÊ≥¢ 10Hz - Â∞àÊ≥®ËàáÂπ≥Èùú</li>
                <li><strong>Á∑äÂºµÁãÄÊÖã</strong> (&gt;20Ê¨°/ÂàÜ)ÔºöBetaÊ≥¢ 14Hz - ÊèêÂçáÂ∞àÊ≥®Âäõ</li>
            </ul>
        </div>

        <div class="config-audio-container">
            <div class="audio-search-section">
                <h4 id="audioSearchTitle">üéµ ËÉåÊôØÈü≥Ê®ÇÊêúÂ∞ã</h4>
                <div class="search-container">
                    <input type="text" id="musicSearchInput" class="search-input" placeholder="ÊêúÂ∞ãÈü≥Ê®Ç... (‰æãÂ¶Ç: Ê£ÆÊûó„ÄÅÊµ∑Êµ™„ÄÅÂÜ•ÊÉ≥)">
                </div>
                <div id="currentSelection" class="current-selection" style="display: none;">
                    <div class="current-selection-label" id="currentSelectionLabel">ÁõÆÂâçÈÅ∏Êìá</div>
                    <div class="current-selection-name" id="currentSelectionName"></div>
                </div>
                <div id="searchResults" class="search-results" style="display: none;"></div>
            </div>

            <div class="config-info">
                <h4 id="systemConfigTitle">üîß Á≥ªÁµ±ÈÖçÁΩÆ</h4>
                <div class="config-item">
                    <span>Âü∫È†ªÈ†ªÁéáÔºö</span>
                    <span id="configBaseFreq">200 Hz</span>
                </div>
                <div class="config-item">
                    <span>ËÉåÊôØÈü≥Ê™îÔºö</span>
                    <span id="configAudioFile">ÁÑ°</span>
                </div>
                <div class="config-item">
                    <span>Èü≥ÈáèÊØî‰æãÔºö</span>
                    <span>ÊãçÈ†ª 30% / ËÉåÊôØÈü≥ 70%</span>
                </div>
                <button onclick="testDevice()" class="device-test-btn" id="deviceTestBtn">
                    üé§ Ë®≠ÂÇôÊ∏¨Ë©¶
                </button>
            </div>
        </div>

        <div class="breathing-monitor">
            <div class="breath-visual">
                <h3>ÂëºÂê∏Ë¶ñË¶∫Âåñ</h3>
                <canvas id="waveform" class="waveform"></canvas>
            </div>

            <div class="breath-stats">
                <h3>Âç≥ÊôÇÊï∏Êìö</h3>
                <div class="stat-item">
                    <span class="stat-label">ÂëºÂê∏ÈÄüÁéáÔºö</span>
                    <span class="stat-value" id="breathRate">-- Ê¨°/ÂàÜ</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Áï∂ÂâçÁãÄÊÖãÔºö</span>
                    <span class="stat-value" id="currentState">ÂæÖÊ™¢Ê∏¨</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ËÖ¶Ê≥¢È°ûÂûãÔºö</span>
                    <span class="stat-value" id="brainwaveType">--</span>
                </div>
            </div>
        </div>

        <div class="control-buttons">
            <button onclick="startAdaptiveMode()" id="startAdaptiveBtn">üéôÔ∏è ÈñãÂßãÂëºÂê∏Áõ£Ê∏¨</button>
            <button onclick="stopAdaptiveMode()" id="stopAdaptiveBtn" disabled>‚èπÔ∏è ÂÅúÊ≠¢Áõ£Ê∏¨</button>
        </div>

        <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
        // ===== ÈñãÁôºËÄÖÈÖçÁΩÆÂçÄÂüü =====
        const CONFIG = {
            // Èü≥Ë®äË®≠ÂÆö
            BASE_FREQUENCY: 200,              // Âü∫È†ª (Hz)
            BINAURAL_VOLUME: 0.3,            // ÊãçÈ†ªÈü≥Èáè (0.0-1.0)
            BACKGROUND_VOLUME: 0.7,          // ËÉåÊôØÈü≥Èü≥Èáè (0.0-1.0)
            SAMPLE_RATE: 16000,              // ÂèñÊ®£Áéá
            ANALYSIS_DURATION: 10,           // ÂàÜÊûêÊôÇÈñìÈï∑Â∫¶ (Áßí)
            BREATH_DETECTION_SENSITIVITY: 0.7, // ÂëºÂê∏Ê™¢Ê∏¨ÊïèÊÑüÂ∫¶ (0.0-1.0)
            
            // Ë™ûË®ÄË®≠ÂÆö
            LANGUAGE: 'auto',                // 'auto' ÁÇ∫Ëá™ÂãïÂÅµÊ∏¨ÔºåÊàñÊåáÂÆö 'zh-TW', 'zh-CN', 'en', 'ja', 'ko'
            FALLBACK_LANGUAGE: 'zh-TW',      // Ëá™ÂãïÂÅµÊ∏¨Â§±ÊïóÊôÇÁöÑÈ†êË®≠Ë™ûË®Ä
            
            // IPinfo Âú∞ÁêÜ‰ΩçÁΩÆÂÅµÊ∏¨Ë®≠ÂÆö
            IPINFO: {
                API_TOKEN: '',               // IPinfo API Token (ÂèØÁïôÁ©∫‰ΩøÁî®ÂÖçË≤ªÈ°çÂ∫¶)
                ENABLE_AUTO_LANGUAGE: true,  // ÊòØÂê¶ÂïüÁî®Ê†πÊìöÂú∞ÁêÜ‰ΩçÁΩÆËá™ÂãïÂàáÊèõË™ûË®Ä
                TIMEOUT: 5000               // API Ë´ãÊ±ÇË∂ÖÊôÇÊôÇÈñì (ÊØ´Áßí)
            },
            
            // Google Analytics Ë®≠ÂÆö
            GOOGLE_ANALYTICS: {
                GA_ID: '',                    // GA4 Ê∏¨ÈáèID (‰æã: 'G-XXXXXXXXXX')
                ENABLE_TRACKING: false,       // ÊòØÂê¶ÂïüÁî®ËøΩËπ§
                TRACK_EVENTS: {
                    START_MONITORING: true,   // ËøΩËπ§ÈñãÂßãÁõ£Ê∏¨‰∫ã‰ª∂
                    STOP_MONITORING: true,    // ËøΩËπ§ÂÅúÊ≠¢Áõ£Ê∏¨‰∫ã‰ª∂
                    BREATH_STATE_CHANGE: true, // ËøΩËπ§ÂëºÂê∏ÁãÄÊÖãËÆäÂåñ‰∫ã‰ª∂
                    LANGUAGE_DETECTION: true  // ËøΩËπ§Ë™ûË®ÄÂÅµÊ∏¨‰∫ã‰ª∂
                }
            },
            
            // Èü≥Ê®ÇÂÖßÂÆπÈÅ∏Êìá
            MUSIC_CONTENT: {
                TYPE: 'nature',              // 'nature', 'ambient', 'meditation', 'white_noise', 'custom'
                CUSTOM_URL: '',              // Áï∂ TYPE ÁÇ∫ 'custom' ÊôÇ‰ΩøÁî®ÁöÑËá™Ë®ÇURL
                LOOP: true,                  // ÊòØÂê¶Âæ™Áí∞Êí≠Êîæ
                FADE_IN_DURATION: 3,         // Ê∑°ÂÖ•ÊôÇÈñì (Áßí)
                FADE_OUT_DURATION: 3         // Ê∑°Âá∫ÊôÇÈñì (Áßí)
            }
        };

        // ÂúãÂÆ∂‰ª£Á¢ºÂ∞çÊáâË™ûË®ÄÊò†Â∞Ñ
        const COUNTRY_LANGUAGE_MAP = {
            'TW': 'zh-TW',      // Âè∞ÁÅ£ -> ÁπÅÈ´î‰∏≠Êñá
            'HK': 'zh-TW',      // È¶ôÊ∏Ø -> ÁπÅÈ´î‰∏≠Êñá
            'MO': 'zh-TW',      // Êæ≥ÈñÄ -> ÁπÅÈ´î‰∏≠Êñá
            'CN': 'zh-CN',      // ‰∏≠Âúã -> Á∞°È´î‰∏≠Êñá
            'SG': 'zh-CN',      // Êñ∞Âä†Âù° -> Á∞°È´î‰∏≠Êñá (ËèØË™ûÁî®Êà∂ËºÉÂ§ö‰ΩøÁî®Á∞°È´î)
            'US': 'en',         // ÁæéÂúã -> Ëã±Êñá
            'GB': 'en',         // Ëã±Âúã -> Ëã±Êñá
            'CA': 'en',         // Âä†ÊãøÂ§ß -> Ëã±Êñá
            'AU': 'en',         // Êæ≥Ê¥≤ -> Ëã±Êñá
            'NZ': 'en',         // Á¥êË•øËò≠ -> Ëã±Êñá
            'IN': 'en',         // Âç∞Â∫¶ -> Ëã±Êñá
            'JP': 'ja',         // Êó•Êú¨ -> Êó•Êñá
            'KR': 'ko'          // ÈüìÂúã -> ÈüìÊñá
        };

        // È†êË®≠Èü≥Ê®ÇÂ∫´
        const MUSIC_LIBRARY = {
            nature: [
                { 
                    name: 'Ê£ÆÊûóÈõ®ËÅ≤', 
                    name_en: 'Forest Rain',
                    url: 'https://cdn.pixabay.com/audio/2022/03/10/audio_2f2e3908a4.mp3',
                    keywords: ['Ê£ÆÊûó', 'Èõ®ËÅ≤', '‰∏ãÈõ®', 'Ê®πÊûó', 'forest', 'rain', 'trees', 'senlin', 'yusheng', 'xiaoyu'],
                    description: 'Ê∑±Êûó‰∏≠ÁöÑÁ¥∞Èõ®ËÅ≤ÔºåÂ∏∂‰æÜÂØßÈùúÊîæÈ¨ÜÁöÑÊÑüÂèó'
                },
                { 
                    name: 'Êµ∑Êµ™ËÅ≤', 
                    name_en: 'Ocean Waves',
                    url: 'https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3',
                    keywords: ['Êµ∑Êµ™', 'Êµ∑Ê¥ã', 'Ê≥¢Êµ™', 'Êµ∑ÈÇä', 'ocean', 'waves', 'sea', 'beach', 'hailang', 'haiyang', 'bolang'],
                    description: 'Ê∫´ÊüîÁöÑÊµ∑Êµ™ÊãçÊâìËÅ≤ÔºåÊ®°Êì¨Êµ∑ÈÇäÁöÑÂØßÈùúÊ∞õÂúç'
                },
                { 
                    name: 'È≥•È≥¥ËÅ≤', 
                    name_en: 'Bird Songs',
                    url: 'https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c7a7ce.mp3',
                    keywords: ['È≥•È≥¥', 'È≥•Âè´', 'È≥•ËÅ≤', 'Ëá™ÁÑ∂', 'birds', 'singing', 'chirping', 'niaomine', 'niaojiao', 'ziran'],
                    description: 'Ê∏ÖÊô®È≥•ÂÖíÁöÑÊÇÖËÄ≥Ê≠åËÅ≤ÔºåÂÖÖÊªøÁîüÊ©üËàáÊ¥ªÂäõ'
                }
            ],
            ambient: [
                { 
                    name: 'Áí∞Â¢ÉÈü≥Ê®Ç', 
                    name_en: 'Ambient Music',
                    url: 'https://cdn.pixabay.com/audio/2022/02/11/audio_8be2d3a1c8.mp3',
                    keywords: ['Áí∞Â¢É', 'Ê∞õÂúç', 'ËÉåÊôØ', 'Èü≥Ê®Ç', 'ambient', 'atmosphere', 'background', 'huanjing', 'fenwei', 'beinjing'],
                    description: 'ÊüîÂíåÁöÑÁí∞Â¢ÉÈü≥Ê®ÇÔºåÂâµÈÄ†ËàíÈÅ©ÁöÑËÉåÊôØÊ∞õÂúç'
                },
                { 
                    name: 'Â§™Á©∫Èü≥Ê®Ç', 
                    name_en: 'Space Music',
                    url: 'https://cdn.pixabay.com/audio/2021/12/06/audio_2b1e9d4c5a.mp3',
                    keywords: ['Â§™Á©∫', 'ÂÆáÂÆô', 'ÊòüÁ©∫', 'ÁßëÂπª', 'space', 'cosmic', 'universe', 'sci-fi', 'taikong', 'yuzhou', 'xingkong'],
                    description: 'Á•ûÁßòÁöÑÂ§™Á©∫Èü≥ÊïàÔºåÂ∏∂‰æÜÁÑ°ÈôêÊÉ≥ÂÉèÁ©∫Èñì'
                }
            ],
            meditation: [
                { 
                    name: 'ÂÜ•ÊÉ≥Èü≥Ê®Ç', 
                    name_en: 'Meditation Music',
                    url: 'https://cdn.pixabay.com/audio/2022/01/18/audio_7d5c8f9b2e.mp3',
                    keywords: ['ÂÜ•ÊÉ≥', 'ÈùúÂøÉ', 'Á¶™‰øÆ', 'ÊîæÈ¨Ü', 'meditation', 'mindfulness', 'zen', 'relax', 'mingxiang', 'jingxin', 'chanxiu'],
                    description: 'Â∞àÁÇ∫ÂÜ•ÊÉ≥Ë®≠Ë®àÁöÑÂØßÈùúÈü≥Ê®ÇÔºåÂπ´Âä©Ê∑±Â∫¶ÊîæÈ¨Ü'
                },
                { 
                    name: 'ÁôÇÁôíÈü≥Ê®Ç', 
                    name_en: 'Healing Music',
                    url: 'https://cdn.pixabay.com/audio/2021/11/21/audio_4a8c9e7f1b.mp3',
                    keywords: ['ÁôÇÁôí', 'Ê≤ªÁôÇ', '‰øÆÂæ©', 'ËàíÁ∑©', 'healing', 'therapy', 'soothing', 'recovery', 'liaoyu', 'zhiliao', 'shufu'],
                    description: 'ÂÖ∑ÊúâÁôÇÁôíÊïàÊûúÁöÑÈü≥Ê®ÇÔºåÊí´ÊÖ∞ÂøÉÈùàÂâµÂÇ∑'
                }
            ],
            white_noise: [
                { 
                    name: 'ÁôΩÂô™Èü≥', 
                    name_en: 'White Noise',
                    url: 'https://cdn.pixabay.com/audio/2022/06/15/audio_9c3f2a8d7e.mp3',
                    keywords: ['ÁôΩÂô™Èü≥', 'Âô™Èü≥', 'Â∞àÊ≥®', 'ÈÅÆËîΩ', 'white noise', 'focus', 'masking', 'baizaoyin', 'zhuanzhu', 'zhebei'],
                    description: 'ÂùáÂãªÁöÑÁôΩÂô™Èü≥ÔºåÂπ´Âä©Â∞àÊ≥®ÂíåÈÅÆËîΩÂ§ñÁïåÂπ≤Êìæ'
                },
                { 
                    name: 'Á≤âÁ¥ÖÂô™Èü≥', 
                    name_en: 'Pink Noise',
                    url: 'https://cdn.pixabay.com/audio/2021/09/30/audio_6b5e1f4a9c.mp3',
                    keywords: ['Á≤âÁ¥ÖÂô™Èü≥', 'Áù°Áú†', 'Ê∑±Â±§', '‰ºëÊÅØ', 'pink noise', 'sleep', 'deep', 'rest', 'fenhongzaoyin', 'shuimian', 'xiuxi'],
                    description: 'Ê∫´ÂíåÁöÑÁ≤âÁ¥ÖÂô™Èü≥Ôºå‰øÉÈÄ≤Ê∑±Â±§Áù°Áú†ÂìÅË≥™'
                }
            ]
        };

        // ÊãçÈ†ªÈÖçÁΩÆÂ∞çÊáâË°®
        const BEAT_FREQUENCY_MAP = {
            'deep_relaxed': 4,    // Ê∑±Â∫¶ÊîæÈ¨Ü - DeltaÊ≥¢
            'relaxed': 6,         // ÊîæÈ¨ÜÁãÄÊÖã - ThetaÊ≥¢  
            'normal': 10,         // Ê≠£Â∏∏ÁãÄÊÖã - AlphaÊ≥¢
            'tense': 14           // Á∑äÂºµÁãÄÊÖã - BetaÊ≥¢
        };

        // Â§öÂúãË™ûË®ÄÂÖßÂÆπ
        const LANGUAGE_CONTENT = {
            'zh-TW': {
                title: 'üßò Êô∫ËÉΩÂëºÂê∏ÊãçÈ†ªËôïÁêÜÂô®',
                subtitle: 'ü§ñ Êô∫ËÉΩÂëºÂê∏Áõ£Ê∏¨',
                description: 'Á≥ªÁµ±ÊúÉÂç≥ÊôÇÁõ£Ê∏¨‰Ω†ÁöÑÂëºÂê∏ÁãÄÊÖãÔºå‰∏¶Ëá™ÂãïË™øÊï¥ÊãçÈ†ª‰æÜÂºïÂ∞é‰Ω†ÈÄ≤ÂÖ•‰∏çÂêåÁöÑÊÑèË≠òÁãÄÊÖãÔºö',
                states: {
                    deep_relaxed: 'Ê∑±Â∫¶ÊîæÈ¨Ü',
                    relaxed: 'ÊîæÈ¨ÜÁãÄÊÖã', 
                    normal: 'Ê≠£Â∏∏ÁãÄÊÖã',
                    tense: 'Á∑äÂºµÁãÄÊÖã'
                },
                stateDescriptions: {
                    deep_relaxed: '(&lt;10Ê¨°/ÂàÜ)ÔºöDeltaÊ≥¢ 4Hz - Ê∑±Â∫¶ÂÜ•ÊÉ≥Ëàá‰øÆÂæ©',
                    relaxed: '(10-15Ê¨°/ÂàÜ)ÔºöThetaÊ≥¢ 6Hz - ÂâµÊÑèËàáÁõ¥Ë¶∫',
                    normal: '(15-20Ê¨°/ÂàÜ)ÔºöAlphaÊ≥¢ 10Hz - Â∞àÊ≥®ËàáÂπ≥Èùú',
                    tense: '(&gt;20Ê¨°/ÂàÜ)ÔºöBetaÊ≥¢ 14Hz - ÊèêÂçáÂ∞àÊ≥®Âäõ'
                },
                labels: {
                    breathRate: 'ÂëºÂê∏ÈÄüÁéáÔºö',
                    currentState: 'Áï∂ÂâçÁãÄÊÖãÔºö',
                    beatFreq: 'ÊãçÈ†ªÈ†ªÁéáÔºö',
                    brainwave: 'ËÖ¶Ê≥¢È°ûÂûãÔºö',
                    baseFreq: 'Âü∫È†ªÈ†ªÁéáÔºö',
                    audioFile: 'ËÉåÊôØÈü≥Ê™îÔºö',
                    volumeRatio: 'Èü≥ÈáèÊØî‰æãÔºö',
                    breathVisual: 'ÂëºÂê∏Ë¶ñË¶∫Âåñ',
                    realTimeData: 'Âç≥ÊôÇÊï∏Êìö',
                    systemConfig: 'üîß Á≥ªÁµ±ÈÖçÁΩÆ',
                    audioSearch: 'üéµ ËÉåÊôØÈü≥Ê®ÇÊêúÂ∞ã',
                    searchPlaceholder: 'ÊêúÂ∞ãÈü≥Ê®Ç... (‰æãÂ¶Ç: Ê£ÆÊûó„ÄÅÊµ∑Êµ™„ÄÅÂÜ•ÊÉ≥)',
                    noResults: 'Êâæ‰∏çÂà∞Áõ∏ÈóúÈü≥Ê®Ç',
                    currentMusic: 'ÁõÆÂâçÈÅ∏Êìá',
                    deviceTest: 'Ë®≠ÂÇôÊ∏¨Ë©¶'
                },
                buttons: {
                    start: 'üéôÔ∏è ÈñãÂßãÂëºÂê∏Áõ£Ê∏¨',
                    stop: '‚èπÔ∏è ÂÅúÊ≠¢Áõ£Ê∏¨'
                },
                status: {
                    monitoring: 'üéôÔ∏è ÂëºÂê∏Áõ£Ê∏¨‰∏≠... Ë´ã‰øùÊåÅËá™ÁÑ∂ÂëºÂê∏',
                    stopped: 'Áõ£Ê∏¨Â∑≤ÂÅúÊ≠¢',
                    error: '‚ùå ÁÑ°Ê≥ïÂïüÂãïÔºö',
                    unsupported: '‚ö†Ô∏è ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥È∫•ÂÖãÈ¢®ÂäüËÉΩÔºåÁÑ°Ê≥ï‰ΩøÁî®ÂëºÂê∏Áõ£Ê∏¨',
                    waiting: 'ÂæÖÊ™¢Ê∏¨'
                },
                units: {
                    perMin: 'Ê¨°/ÂàÜ',
                    hz: 'Hz',
                    none: 'ÁÑ°'
                },
                waves: {
                    delta: 'DeltaÊ≥¢',
                    theta: 'ThetaÊ≥¢', 
                    alpha: 'AlphaÊ≥¢',
                    beta: 'BetaÊ≥¢'
                }
            },
            'zh-CN': {
                title: 'üßò Êô∫ËÉΩÂëºÂê∏ÊãçÈ¢ëÂ§ÑÁêÜÂô®',
                subtitle: 'ü§ñ Êô∫ËÉΩÂëºÂê∏ÁõëÊµã',
                description: 'Á≥ªÁªü‰ºöÂÆûÊó∂ÁõëÊµã‰Ω†ÁöÑÂëºÂê∏Áä∂ÊÄÅÔºåÂπ∂Ëá™Âä®Ë∞ÉÊï¥ÊãçÈ¢ëÊù•ÂºïÂØº‰Ω†ËøõÂÖ•‰∏çÂêåÁöÑÊÑèËØÜÁä∂ÊÄÅÔºö',
                states: {
                    deep_relaxed: 'Ê∑±Â∫¶ÊîæÊùæ',
                    relaxed: 'ÊîæÊùæÁä∂ÊÄÅ',
                    normal: 'Ê≠£Â∏∏Áä∂ÊÄÅ', 
                    tense: 'Á¥ßÂº†Áä∂ÊÄÅ'
                },
                stateDescriptions: {
                    deep_relaxed: '(&lt;10Ê¨°/ÂàÜ)ÔºöDeltaÊ≥¢ 4Hz - Ê∑±Â∫¶ÂÜ•ÊÉ≥‰∏é‰øÆÂ§ç',
                    relaxed: '(10-15Ê¨°/ÂàÜ)ÔºöThetaÊ≥¢ 6Hz - ÂàõÊÑè‰∏éÁõ¥Ëßâ',
                    normal: '(15-20Ê¨°/ÂàÜ)ÔºöAlphaÊ≥¢ 10Hz - ‰∏ìÊ≥®‰∏éÂπ≥Èùô',
                    tense: '(&gt;20Ê¨°/ÂàÜ)ÔºöBetaÊ≥¢ 14Hz - ÊèêÂçá‰∏ìÊ≥®Âäõ'
                },
                labels: {
                    breathRate: 'ÂëºÂê∏ÈÄüÁéáÔºö',
                    currentState: 'ÂΩìÂâçÁä∂ÊÄÅÔºö',
                    beatFreq: 'ÊãçÈ¢ëÈ¢ëÁéáÔºö',
                    brainwave: 'ËÑëÊ≥¢Á±ªÂûãÔºö',
                    baseFreq: 'Âü∫È¢ëÈ¢ëÁéáÔºö',
                    audioFile: 'ËÉåÊôØÈü≥Ê°£Ôºö',
                    volumeRatio: 'Èü≥ÈáèÊØî‰æãÔºö',
                    breathVisual: 'ÂëºÂê∏ÂèØËßÜÂåñ',
                    realTimeData: 'ÂÆûÊó∂Êï∞ÊçÆ',
                    systemConfig: 'üîß Á≥ªÁªüÈÖçÁΩÆ',
                    audioSearch: 'üéµ ËÉåÊôØÈü≥‰πêÊêúÂØª',
                    searchPlaceholder: 'ÊêúÂØªÈü≥‰πê... (‰æãÂ¶Ç: Ê£ÆÊûó„ÄÅÊµ∑Êµ™„ÄÅÂÜ•ÊÉ≥)',
                    noResults: 'Êâæ‰∏çÂà∞Áõ∏ÂÖ≥Èü≥‰πê',
                    currentMusic: 'ÁõÆÂâçÈÄâÊã©',
                    deviceTest: 'ËÆæÂ§áÊµãËØï'
                },
                buttons: {
                    start: 'üéôÔ∏è ÂºÄÂßãÂëºÂê∏ÁõëÊµã',
                    stop: '‚èπÔ∏è ÂÅúÊ≠¢ÁõëÊµã'
                },
                status: {
                    monitoring: 'üéôÔ∏è ÂëºÂê∏ÁõëÊµã‰∏≠... ËØ∑‰øùÊåÅËá™ÁÑ∂ÂëºÂê∏',
                    stopped: 'ÁõëÊµãÂ∑≤ÂÅúÊ≠¢',
                    error: '‚ùå Êó†Ê≥ïÂêØÂä®Ôºö',
                    unsupported: '‚ö†Ô∏è ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈ∫¶ÂÖãÈ£éÂäüËÉΩÔºåÊó†Ê≥ï‰ΩøÁî®ÂëºÂê∏ÁõëÊµã',
                    waiting: 'ÂæÖÊ£ÄÊµã'
                },
                units: {
                    perMin: 'Ê¨°/ÂàÜ',
                    hz: 'Hz',
                    none: 'Êó†'
                },
                waves: {
                    delta: 'DeltaÊ≥¢',
                    theta: 'ThetaÊ≥¢',
                    alpha: 'AlphaÊ≥¢', 
                    beta: 'BetaÊ≥¢'
                }
            },
            'en': {
                title: 'üßò Smart Breathing Binaural Processor',
                subtitle: 'ü§ñ Smart Breathing Monitor',
                description: 'The system monitors your breathing patterns in real-time and automatically adjusts binaural beats to guide you into different states of consciousness:',
                states: {
                    deep_relaxed: 'Deep Relaxed',
                    relaxed: 'Relaxed',
                    normal: 'Normal',
                    tense: 'Tense'
                },
                stateDescriptions: {
                    deep_relaxed: '(&lt;10/min): Delta 4Hz - Deep meditation & restoration',
                    relaxed: '(10-15/min): Theta 6Hz - Creativity & intuition',
                    normal: '(15-20/min): Alpha 10Hz - Focus & calm',
                    tense: '(&gt;20/min): Beta 14Hz - Enhanced concentration'
                },
                labels: {
                    breathRate: 'Breath Rate:',
                    currentState: 'Current State:',
                    beatFreq: 'Beat Frequency:',
                    brainwave: 'Brainwave:',
                    baseFreq: 'Base Frequency:',
                    audioFile: 'Background Audio:',
                    volumeRatio: 'Volume Ratio:',
                    breathVisual: 'Breath Visualization',
                    realTimeData: 'Real-time Data',
                    systemConfig: 'üîß System Configuration',
                    audioSearch: 'üéµ Background Music Search',
                    searchPlaceholder: 'Search music... (e.g: forest, ocean, meditation)',
                    noResults: 'No matching music found',
                    currentMusic: 'Currently Selected',
                    deviceTest: 'Device Test'
                },
                buttons: {
                    start: 'üéôÔ∏è Start Monitoring',
                    stop: '‚èπÔ∏è Stop Monitoring'
                },
                status: {
                    monitoring: 'üéôÔ∏è Monitoring breathing... Please breathe naturally',
                    stopped: 'Monitoring stopped',
                    error: '‚ùå Failed to start:',
                    unsupported: '‚ö†Ô∏è Your browser does not support microphone access',
                    waiting: 'Waiting'
                },
                units: {
                    perMin: '/min',
                    hz: 'Hz',
                    none: 'None'
                },
                waves: {
                    delta: 'Delta',
                    theta: 'Theta',
                    alpha: 'Alpha',
                    beta: 'Beta'
                }
            },
            'ja': {
                title: 'üßò „Çπ„Éû„Éº„ÉàÂëºÂê∏„Éê„Ç§„Éé„Éº„É©„É´„Éó„É≠„Çª„ÉÉ„Çµ„Éº',
                subtitle: 'ü§ñ „Çπ„Éû„Éº„ÉàÂëºÂê∏„É¢„Éã„Çø„É™„É≥„Ç∞',
                description: '„Ç∑„Çπ„ÉÜ„É†„Åå„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÂëºÂê∏„Éë„Çø„Éº„É≥„ÇíÁõ£Ë¶ñ„Åó„ÄÅÁï∞„Å™„ÇãÊÑèË≠òÁä∂ÊÖã„Å´Â∞é„Åè„Åü„ÇÅ„Å´„Éê„Ç§„Éé„Éº„É©„É´„Éì„Éº„Éà„ÇíËá™ÂãïË™øÊï¥„Åó„Åæ„ÅôÔºö',
                states: {
                    deep_relaxed: 'Ê∑±„ÅÑ„É™„É©„ÉÉ„ÇØ„Çπ',
                    relaxed: '„É™„É©„ÉÉ„ÇØ„Çπ',
                    normal: 'ÈÄöÂ∏∏',
                    tense: 'Á∑äÂºµ'
                },
                stateDescriptions: {
                    deep_relaxed: '(&lt;10Âõû/ÂàÜ)Ôºö„Éá„É´„ÇøÊ≥¢ 4Hz - Ê∑±„ÅÑÁûëÊÉ≥„Å®ÂõûÂæ©',
                    relaxed: '(10-15Âõû/ÂàÜ)Ôºö„Ç∑„Éº„ÇøÊ≥¢ 6Hz - ÂâµÈÄ†ÊÄß„Å®Áõ¥ÊÑü',
                    normal: '(15-20Âõû/ÂàÜ)Ôºö„Ç¢„É´„Éï„Ç°Ê≥¢ 10Hz - ÈõÜ‰∏≠„Å®Âπ≥Èùô',
                    tense: '(&gt;20Âõû/ÂàÜ)Ôºö„Éô„Éº„ÇøÊ≥¢ 14Hz - ÈõÜ‰∏≠ÂäõÂêë‰∏ä'
                },
                labels: {
                    breathRate: 'ÂëºÂê∏Êï∞Ôºö',
                    currentState: 'ÁèæÂú®„ÅÆÁä∂ÊÖãÔºö',
                    beatFreq: '„Éì„Éº„ÉàÂë®Ê≥¢Êï∞Ôºö',
                    brainwave: 'ËÑ≥Ê≥¢Ôºö',
                    baseFreq: 'Âü∫Êú¨Âë®Ê≥¢Êï∞Ôºö',
                    audioFile: '„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÈü≥Â£∞Ôºö',
                    volumeRatio: 'Èü≥ÈáèÊØîÔºö',
                    breathVisual: 'ÂëºÂê∏ÂèØË¶ñÂåñ',
                    realTimeData: '„É™„Ç¢„É´„Çø„Ç§„É†„Éá„Éº„Çø',
                    systemConfig: 'üîß „Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö',
                    audioSearch: 'üéµ ËÉåÊôØÈü≥Ê•ΩÊ§úÁ¥¢',
                    searchPlaceholder: 'Èü≥Ê•Ω„ÇíÊ§úÁ¥¢... (‰æã: Ê£Æ„ÄÅÊµ∑„ÄÅÁûëÊÉ≥)',
                    noResults: 'Ë©≤ÂΩì„Åô„ÇãÈü≥Ê•Ω„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
                    currentMusic: 'ÁèæÂú®ÈÅ∏Êäû‰∏≠',
                    deviceTest: '„Éá„Éê„Ç§„Çπ„ÉÜ„Çπ„Éà'
                },
                buttons: {
                    start: 'üéôÔ∏è „É¢„Éã„Çø„É™„É≥„Ç∞ÈñãÂßã',
                    stop: '‚èπÔ∏è „É¢„Éã„Çø„É™„É≥„Ç∞ÂÅúÊ≠¢'
                },
                status: {
                    monitoring: 'üéôÔ∏è ÂëºÂê∏„Çí„É¢„Éã„Çø„É™„É≥„Ç∞‰∏≠... Ëá™ÁÑ∂„Å´ÂëºÂê∏„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                    stopped: '„É¢„Éã„Çø„É™„É≥„Ç∞„ÅåÂÅúÊ≠¢„Åó„Åæ„Åó„Åü',
                    error: '‚ùå ÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºö',
                    unsupported: '‚ö†Ô∏è „Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ„Éû„Ç§„ÇØ„Ç¢„ÇØ„Çª„Çπ„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì',
                    waiting: 'ÂæÖÊ©ü‰∏≠'
                },
                units: {
                    perMin: 'Âõû/ÂàÜ',
                    hz: 'Hz',
                    none: '„Å™„Åó'
                },
                waves: {
                    delta: '„Éá„É´„ÇøÊ≥¢',
                    theta: '„Ç∑„Éº„ÇøÊ≥¢',
                    alpha: '„Ç¢„É´„Éï„Ç°Ê≥¢',
                    beta: '„Éô„Éº„ÇøÊ≥¢'
                }
            },
            'ko': {
                title: 'üßò Ïä§ÎßàÌä∏ Ìò∏Ìù° Î∞îÏù¥ÎÖ∏Îü¥ ÌîÑÎ°úÏÑ∏ÏÑú',
                subtitle: 'ü§ñ Ïä§ÎßàÌä∏ Ìò∏Ìù° Î™®ÎãàÌÑ∞ÎßÅ',
                description: 'ÏãúÏä§ÌÖúÏù¥ Ïã§ÏãúÍ∞ÑÏúºÎ°ú Ìò∏Ìù° Ìå®ÌÑ¥ÏùÑ Î™®ÎãàÌÑ∞ÎßÅÌïòÍ≥† Îã§ÏñëÌïú ÏùòÏãù ÏÉÅÌÉúÎ°ú ÏïàÎÇ¥ÌïòÍ∏∞ ÏúÑÌï¥ Î∞îÏù¥ÎÖ∏Îü¥ ÎπÑÌä∏Î•º ÏûêÎèô Ï°∞Ï†ïÌï©ÎãàÎã§:',
                states: {
                    deep_relaxed: 'ÍπäÏùÄ Ïù¥ÏôÑ',
                    relaxed: 'Ïù¥ÏôÑ',
                    normal: 'Ï†ïÏÉÅ',
                    tense: 'Í∏¥Ïû•'
                },
                stateDescriptions: {
                    deep_relaxed: '(&lt;10Ìöå/Î∂Ñ): Îç∏ÌÉÄÌåå 4Hz - ÍπäÏùÄ Î™ÖÏÉÅÍ≥º ÌöåÎ≥µ',
                    relaxed: '(10-15Ìöå/Î∂Ñ): ÏÑ∏ÌÉÄÌåå 6Hz - Ï∞ΩÏùòÏÑ±Í≥º ÏßÅÍ∞ê',
                    normal: '(15-20Ìöå/Î∂Ñ): ÏïåÌååÌåå 10Hz - ÏßëÏ§ëÍ≥º ÌèâÏò®',
                    tense: '(&gt;20Ìöå/Î∂Ñ): Î≤†ÌÉÄÌåå 14Hz - ÏßëÏ§ëÎ†• Ìñ•ÏÉÅ'
                },
                labels: {
                    breathRate: 'Ìò∏Ìù° ÏÜçÎèÑ:',
                    currentState: 'ÌòÑÏû¨ ÏÉÅÌÉú:',
                    beatFreq: 'ÎπÑÌä∏ Ï£ºÌååÏàò:',
                    brainwave: 'ÎáåÌåå:',
                    baseFreq: 'Í∏∞Î≥∏ Ï£ºÌååÏàò:',
                    audioFile: 'Î∞∞Í≤Ω Ïò§ÎîîÏò§:',
                    volumeRatio: 'Î≥ºÎ•® ÎπÑÏú®:',
                    breathVisual: 'Ìò∏Ìù° ÏãúÍ∞ÅÌôî',
                    realTimeData: 'Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞',
                    systemConfig: 'üîß ÏãúÏä§ÌÖú Íµ¨ÏÑ±',
                    audioSearch: 'üéµ Î∞∞Í≤ΩÏùåÏïÖ Í≤ÄÏÉâ',
                    searchPlaceholder: 'ÏùåÏïÖ Í≤ÄÏÉâ... (Ïòà: Ïà≤, Î∞îÎã§, Î™ÖÏÉÅ)',
                    noResults: 'ÏùºÏπòÌïòÎäî ÏùåÏïÖÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå',
                    currentMusic: 'ÌòÑÏû¨ ÏÑ†ÌÉùÎê®',
                    deviceTest: 'Ïû•Ïπò ÌÖåÏä§Ìä∏'
                },
                buttons: {
                    start: 'üéôÔ∏è Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë',
                    stop: '‚èπÔ∏è Î™®ÎãàÌÑ∞ÎßÅ Ï§ëÏßÄ'
                },
                status: {
                    monitoring: 'üéôÔ∏è Ìò∏Ìù° Î™®ÎãàÌÑ∞ÎßÅ Ï§ë... ÏûêÏó∞Ïä§ÎüΩÍ≤å Ìò∏Ìù°ÌïòÏÑ∏Ïöî',
                    stopped: 'Î™®ÎãàÌÑ∞ÎßÅÏù¥ Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§',
                    error: '‚ùå ÏãúÏûëÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§:',
                    unsupported: '‚ö†Ô∏è Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÎßàÏù¥ÌÅ¨ Ïï°ÏÑ∏Ïä§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§',
                    waiting: 'ÎåÄÍ∏∞ Ï§ë'
                },
                units: {
                    perMin: 'Ìöå/Î∂Ñ',
                    hz: 'Hz',
                    none: 'ÏóÜÏùå'
                },
                waves: {
                    delta: 'Îç∏ÌÉÄÌåå',
                    theta: 'ÏÑ∏ÌÉÄÌåå',
                    alpha: 'ÏïåÌååÌåå',
                    beta: 'Î≤†ÌÉÄÌåå'
                }
            }
        };
        // ===== ÈÖçÁΩÆÂçÄÂüüÁµêÊùü =====

        let audioContext;
        let isRecording = false;
        let mediaStream;
        let analyser;
        let dataArray;
        let binauralOscillators = [];
        let backgroundAudioSource;
        let backgroundGainNode;
        let currentBeatFreq = 8;
        let currentLanguage = CONFIG.FALLBACK_LANGUAGE;
        let gaInitialized = false;
        let userCountry = null;
        let selectedMusicItem = null;
        let allMusicItems = [];

        // ÂàùÂßãÂåñÈü≥Ê®ÇÊ∏ÖÂñÆ
        function initMusicLibrary() {
            allMusicItems = [];
            Object.keys(MUSIC_LIBRARY).forEach(category => {
                MUSIC_LIBRARY[category].forEach(item => {
                    allMusicItems.push({
                        ...item,
                        category: category
                    });
                });
            });
        }

        // Ê®°Á≥äÊêúÂ∞ãÁÆóÊ≥ï (ÊîØÊè¥ÊãºÈü≥ÂíåÈåØÂ≠ó)
        function fuzzySearch(query, text) {
            if (!query || !text) return 0;
            
            query = query.toLowerCase();
            text = text.toLowerCase();
            
            // ÂÆåÂÖ®ÂåπÈÖçÂæóÂàÜÊúÄÈ´ò
            if (text.includes(query)) return 100;
            
            // Ë®àÁÆóÁ∑®ËºØË∑ùÈõ¢ (Levenshtein distance)
            const editDistance = calculateEditDistance(query, text);
            const maxLen = Math.max(query.length, text.length);
            const similarity = ((maxLen - editDistance) / maxLen) * 100;
            
            return similarity;
        }

        // Ë®àÁÆóÁ∑®ËºØË∑ùÈõ¢
        function calculateEditDistance(a, b) {
            const matrix = [];
            
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[b.length][a.length];
        }

        // Ë™ûÊÑèÊêúÂ∞ãÈü≥Ê®Ç
        function searchMusic(query) {
            if (!query.trim()) return [];
            
            const results = [];
            
            allMusicItems.forEach(item => {
                let maxScore = 0;
                
                // ÊêúÂ∞ãÈü≥Ê®ÇÂêçÁ®±
                const nameScore = Math.max(
                    fuzzySearch(query, item.name),
                    fuzzySearch(query, item.name_en)
                );
                maxScore = Math.max(maxScore, nameScore);
                
                // ÊêúÂ∞ãÈóúÈçµÂ≠ó
                item.keywords.forEach(keyword => {
                    const keywordScore = fuzzySearch(query, keyword);
                    maxScore = Math.max(maxScore, keywordScore);
                });
                
                // ÊêúÂ∞ãÊèèËø∞
                const descScore = fuzzySearch(query, item.description);
                maxScore = Math.max(maxScore, descScore * 0.7); // ÊèèËø∞Ê¨äÈáçËºÉ‰Ωé
                
                // ÊêúÂ∞ãÂàÜÈ°û
                const categoryScore = fuzzySearch(query, item.category);
                maxScore = Math.max(maxScore, categoryScore * 0.5); // ÂàÜÈ°ûÊ¨äÈáçÊúÄ‰Ωé
                
                if (maxScore > 30) { // Ë®≠ÂÆöÊúÄ‰ΩéÁõ∏‰ººÂ∫¶ÈñÄÊ™ª
                    results.push({
                        ...item,
                        score: maxScore
                    });
                }
            });
            
            // ÊåâÂàÜÊï∏ÊéíÂ∫è
            return results.sort((a, b) => b.score - a.score);
        }

        // Ê∏≤ÊüìÊêúÂ∞ãÁµêÊûú
        function renderSearchResults(results) {
            const content = getLanguageContent();
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = `<div class="no-results">${content.labels.noResults}</div>`;
                container.style.display = 'block';
                return;
            }
            
            let html = '';
            results.forEach((item, index) => {
                const isSelected = selectedMusicItem && selectedMusicItem.url === item.url;
                html += `
                    <div class="music-item ${isSelected ? 'selected' : ''}" data-index="${index}">
                        <div class="music-info">
                            <div class="music-name">${item.name} / ${item.name_en}</div>
                            <div class="music-description">${item.description}</div>
                        </div>
                        <div class="music-badge">${item.category}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.style.display = 'block';
            
            // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂Áõ£ËÅΩÂô®
            container.querySelectorAll('.music-item').forEach((element, index) => {
                element.addEventListener('click', () => {
                    const item = results[index];
                    selectMusic(item.url, item.name, item.category);
                });
            });
        }

        // ÈÅ∏ÊìáÈü≥Ê®Ç
        function selectMusic(url, name, category) {
            selectedMusicItem = { url, name, category };
            
            // Êõ¥Êñ∞ÈÖçÁΩÆ
            CONFIG.MUSIC_CONTENT.TYPE = 'custom';
            CONFIG.MUSIC_CONTENT.CUSTOM_URL = url;
            
            // È°ØÁ§∫Áï∂ÂâçÈÅ∏Êìá
            showCurrentSelection(name);
            
            // ÈáçÊñ∞Ê∏≤ÊüìÊêúÂ∞ãÁµêÊûú‰ª•Êõ¥Êñ∞ÈÅ∏‰∏≠ÁãÄÊÖã
            const query = document.getElementById('musicSearchInput').value;
            if (query.trim()) {
                const results = searchMusic(query);
                renderSearchResults(results);
            }
            
            // Â¶ÇÊûúÊ≠£Âú®Áõ£Ê∏¨‰∏≠ÔºåÂàáÊèõËÉåÊôØÈü≥Ê®Ç
            if (isRecording) {
                switchBackgroundMusic(url);
            }
            
            // Google Analytics ËøΩËπ§
            if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.START_MONITORING) {
                trackEvent('music_selected', {
                    music_name: name,
                    music_category: category,
                    language: currentLanguage
                });
            }
        }

        // È°ØÁ§∫Áï∂ÂâçÈÅ∏Êìá
        function showCurrentSelection(name) {
            const content = getLanguageContent();
            const container = document.getElementById('currentSelection');
            const label = document.getElementById('currentSelectionLabel');
            const nameElement = document.getElementById('currentSelectionName');
            
            label.textContent = content.labels.currentMusic;
            nameElement.textContent = name;
            container.style.display = 'block';
        }

        // ÂàáÊèõËÉåÊôØÈü≥Ê®Ç
        function switchBackgroundMusic(url) {
            // ÂÅúÊ≠¢Áï∂ÂâçËÉåÊôØÈü≥Ê®Ç
            if (backgroundAudioSource && backgroundGainNode) {
                backgroundGainNode.gain.exponentialRampToValueAtTime(
                    0.001, 
                    audioContext.currentTime + 1
                );
                setTimeout(() => {
                    if (backgroundAudioSource) {
                        backgroundAudioSource.stop();
                        backgroundAudioSource = null;
                        backgroundGainNode = null;
                    }
                }, 1000);
            }
            
            // ËºâÂÖ•Êñ∞ÁöÑËÉåÊôØÈü≥Ê®Ç
            setTimeout(() => {
                if (url && isRecording) {
                    loadBackgroundAudio(url);
                }
            }, 1000);
        }

        // Ëá™ÂãïÂÅµÊ∏¨Áî®Êà∂Âú∞ÁêÜ‰ΩçÁΩÆÂíåË™ûË®Ä
        function detectUserLanguage() {
            return new Promise((resolve, reject) => {
                // Â¶ÇÊûúË®≠ÂÆöÁÇ∫ÊâãÂãïÊåáÂÆöË™ûË®ÄÔºåÁõ¥Êé•‰ΩøÁî®
                if (CONFIG.LANGUAGE !== 'auto') {
                    currentLanguage = CONFIG.LANGUAGE;
                    resolve(currentLanguage);
                    return;
                }

                // Â¶ÇÊûúÊú™ÂïüÁî®Ëá™ÂãïË™ûË®ÄÂÅµÊ∏¨Ôºå‰ΩøÁî®È†êË®≠Ë™ûË®Ä
                if (!CONFIG.IPINFO.ENABLE_AUTO_LANGUAGE) {
                    currentLanguage = CONFIG.FALLBACK_LANGUAGE;
                    resolve(currentLanguage);
                    return;
                }

                // Âª∫Êßã IPinfo API URL
                const apiUrl = CONFIG.IPINFO.API_TOKEN ? 
                    `https://ipinfo.io/json?token=${CONFIG.IPINFO.API_TOKEN}` : 
                    'https://ipinfo.io/json';

                // Ë®≠ÂÆöË´ãÊ±ÇË∂ÖÊôÇ
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.IPINFO.TIMEOUT);

                fetch(apiUrl, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                }).then(response => {
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`IPinfo API Ë´ãÊ±ÇÂ§±Êïó: ${response.status}`);
                    }

                    return response.json();
                }).then(data => {
                    userCountry = data.country;

                    // Ê†πÊìöÂúãÂÆ∂‰ª£Á¢ºÊò†Â∞ÑË™ûË®Ä
                    if (userCountry && COUNTRY_LANGUAGE_MAP[userCountry]) {
                        currentLanguage = COUNTRY_LANGUAGE_MAP[userCountry];
                    } else {
                        // Â¶ÇÊûúÂúãÂÆ∂‰ª£Á¢º‰∏çÂú®Êò†Â∞ÑË°®‰∏≠ÔºåÂòóË©¶‰ΩøÁî®ÁÄèË¶ΩÂô®Ë™ûË®Ä
                        currentLanguage = getBrowserLanguage();
                    }

                    // Google Analytics ËøΩËπ§Ë™ûË®ÄÂÅµÊ∏¨
                    if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.LANGUAGE_DETECTION) {
                        trackEvent('language_detection', {
                            detected_country: userCountry,
                            detected_language: currentLanguage,
                            detection_method: 'ipinfo_api',
                            browser_language: navigator.language
                        });
                    }

                    console.log(`üåç Ëá™ÂãïÂÅµÊ∏¨Ë™ûË®Ä: ${userCountry} -> ${currentLanguage}`);
                    resolve(currentLanguage);

                }).catch(error => {
                    clearTimeout(timeoutId);
                    console.warn('Ë™ûË®ÄËá™ÂãïÂÅµÊ∏¨Â§±Êïó:', error.message);
                    
                    // ÈôçÁ¥öÂà∞ÁÄèË¶ΩÂô®Ë™ûË®ÄÂÅµÊ∏¨
                    currentLanguage = getBrowserLanguage();

                    // ËøΩËπ§ÂÅµÊ∏¨Â§±Êïó‰∫ã‰ª∂
                    if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.LANGUAGE_DETECTION) {
                        trackEvent('language_detection_failed', {
                            error_message: error.message,
                            fallback_language: currentLanguage,
                            detection_method: 'browser_language'
                        });
                    }
                    
                    resolve(currentLanguage);
                });
            });
        }

        // ÂæûÁÄèË¶ΩÂô®Ë™ûË®ÄË®≠ÂÆöÊé®Êñ∑Ë™ûË®Ä
        function getBrowserLanguage() {
            const browserLang = navigator.language || navigator.languages[0] || CONFIG.FALLBACK_LANGUAGE;
            
            // ËΩâÊèõÁÄèË¶ΩÂô®Ë™ûË®Ä‰ª£Á¢ºÁÇ∫ÊáâÁî®ÊîØÊè¥ÁöÑË™ûË®Ä
            if (browserLang.startsWith('zh')) {
                if (browserLang.includes('TW') || browserLang.includes('HK') || browserLang.includes('MO')) {
                    return 'zh-TW';
                } else {
                    return 'zh-CN';
                }
            } else if (browserLang.startsWith('ja')) {
                return 'ja';
            } else if (browserLang.startsWith('ko')) {
                return 'ko';
            } else if (browserLang.startsWith('en')) {
                return 'en';
            } else {
                return CONFIG.FALLBACK_LANGUAGE;
            }
        }

        // ÂàùÂßãÂåñ Google Analytics
        function initGoogleAnalytics() {
            if (!CONFIG.GOOGLE_ANALYTICS.ENABLE_TRACKING || !CONFIG.GOOGLE_ANALYTICS.GA_ID || gaInitialized) {
                return;
            }

            // ËºâÂÖ• GA4 ËÖ≥Êú¨
            const script1 = document.createElement('script');
            script1.async = true;
            script1.src = `https://www.googletagmanager.com/gtag/js?id=${CONFIG.GOOGLE_ANALYTICS.GA_ID}`;
            document.head.appendChild(script1);

            // ÂàùÂßãÂåñ GA4
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            window.gtag = gtag;
            gtag('js', new Date());
            gtag('config', CONFIG.GOOGLE_ANALYTICS.GA_ID);

            gaInitialized = true;
        }

        // ÁôºÈÄÅ GA ‰∫ã‰ª∂
        function trackEvent(eventName, parameters = {}) {
            if (!CONFIG.GOOGLE_ANALYTICS.ENABLE_TRACKING || !window.gtag) {
                return;
            }

            window.gtag('event', eventName, {
                event_category: 'binaural_beats',
                ...parameters
            });
        }

        // Áç≤ÂèñÁï∂ÂâçË™ûË®ÄÂÖßÂÆπ
        function getLanguageContent() {
            return LANGUAGE_CONTENT[currentLanguage] || LANGUAGE_CONTENT['zh-TW'];
        }

        // Êõ¥Êñ∞È†ÅÈù¢Ë™ûË®ÄÂÖßÂÆπ
        function updateLanguageContent() {
            const content = getLanguageContent();
            
            // Êõ¥Êñ∞‰∏ªË¶ÅÊ®ôÈ°å
            document.querySelector('h1').textContent = content.title;
            document.querySelector('.adaptive-mode h3').textContent = content.subtitle;
            document.querySelector('.adaptive-mode p').textContent = content.description;
            
            // Êõ¥Êñ∞ÁãÄÊÖãÊèèËø∞
            const listItems = document.querySelectorAll('.adaptive-mode li');
            listItems[0].innerHTML = `<strong>${content.states.deep_relaxed}</strong> ${content.stateDescriptions.deep_relaxed}`;
            listItems[1].innerHTML = `<strong>${content.states.relaxed}</strong> ${content.stateDescriptions.relaxed}`;
            listItems[2].innerHTML = `<strong>${content.states.normal}</strong> ${content.stateDescriptions.normal}`;
            listItems[3].innerHTML = `<strong>${content.states.tense}</strong> ${content.stateDescriptions.tense}`;
            
            // Êõ¥Êñ∞ÈÖçÁΩÆÂçÄÂüü
            document.getElementById('systemConfigTitle').textContent = content.labels.systemConfig;
            document.getElementById('audioSearchTitle').textContent = content.labels.audioSearch;
            
            // Êõ¥Êñ∞ÊêúÂ∞ãÊ°Ü‰Ωî‰ΩçÁ¨¶
            document.getElementById('musicSearchInput').placeholder = content.labels.searchPlaceholder;
            
            // Êõ¥Êñ∞Ë®≠ÂÇôÊ∏¨Ë©¶ÊåâÈàï
            document.getElementById('deviceTestBtn').innerHTML = `üé§ ${content.labels.deviceTest}`;
            
            // Êõ¥Êñ∞Ê®ôÁ±§
            document.querySelector('.breath-visual h3').textContent = content.labels.breathVisual;
            document.querySelector('.breath-stats h3').textContent = content.labels.realTimeData;
            
            // Êõ¥Êñ∞Áµ±Ë®àÊ®ôÁ±§
            document.querySelectorAll('.stat-label')[0].textContent = content.labels.breathRate;
            document.querySelectorAll('.stat-label')[1].textContent = content.labels.currentState;
            document.querySelectorAll('.stat-label')[2].textContent = content.labels.brainwave;
            
            // Êõ¥Êñ∞ÊåâÈàï
            document.getElementById('startAdaptiveBtn').textContent = content.buttons.start;
            document.getElementById('stopAdaptiveBtn').textContent = content.buttons.stop;
            
            // ÈáçÁΩÆÁµ±Ë®àÈ°ØÁ§∫
            resetStatsDisplay();
        }

        // ÈáçÁΩÆÁµ±Ë®àÈ°ØÁ§∫
        function resetStatsDisplay() {
            const content = getLanguageContent();
            document.getElementById('breathRate').textContent = `-- ${content.units.perMin}`;
            document.getElementById('currentState').textContent = content.status.waiting;
            document.getElementById('brainwaveType').textContent = '--';
        }

        // Áç≤ÂèñËÉåÊôØÈü≥Ê™îURL
        function getBackgroundAudioUrl() {
            if (CONFIG.MUSIC_CONTENT.TYPE === 'custom') {
                return CONFIG.MUSIC_CONTENT.CUSTOM_URL;
            }
            
            const musicList = MUSIC_LIBRARY[CONFIG.MUSIC_CONTENT.TYPE];
            if (musicList && musicList.length > 0) {
                // Èö®Ê©üÈÅ∏Êìá‰∏ÄÈ¶ñÈü≥Ê®Ç
                const randomIndex = Math.floor(Math.random() * musicList.length);
                return musicList[randomIndex].url;
            }
            
            return '';
        }

        // ÂàùÂßãÂåñÈÖçÁΩÆÈ°ØÁ§∫
        function initConfigDisplay() {
            const content = getLanguageContent();
            const audioUrl = getBackgroundAudioUrl();
            
            document.getElementById('configBaseFreq').textContent = `${CONFIG.BASE_FREQUENCY} ${content.units.hz}`;
            
            // È°ØÁ§∫Èü≥Ê®ÇÈ°ûÂûãÂíåÂúãÂÆ∂Ë≥áË®ä
            let audioInfo = content.units.none;
            if (audioUrl) {
                if (CONFIG.MUSIC_CONTENT.TYPE === 'custom') {
                    audioInfo = audioUrl.split('/').pop();
                } else {
                    audioInfo = CONFIG.MUSIC_CONTENT.TYPE;
                }
            }
            
            // Â¶ÇÊûúÊúâÂÅµÊ∏¨Âà∞ÂúãÂÆ∂ÔºåÈ°ØÁ§∫ÂúãÂÆ∂Ë≥áË®ä
            if (userCountry) {
                audioInfo += ` (${userCountry})`;
            }
            
            document.getElementById('configAudioFile').textContent = audioInfo;
        }

        // È°ØÁ§∫Ë™ûË®ÄÂÅµÊ∏¨ÁãÄÊÖã
        function showLanguageDetectionStatus() {
            const content = getLanguageContent();
            let statusMessage = '';
            
            if (CONFIG.LANGUAGE === 'auto') {
                if (userCountry) {
                    statusMessage = `üåç Â∑≤Ëá™ÂãïÂÅµÊ∏¨: ${userCountry} ‚Üí ${currentLanguage}`;
                } else {
                    statusMessage = `üåê ‰ΩøÁî®ÁÄèË¶ΩÂô®Ë™ûË®Ä: ${currentLanguage}`;
                }
            } else {
                statusMessage = `‚öôÔ∏è ÊâãÂãïË®≠ÂÆöË™ûË®Ä: ${currentLanguage}`;
            }
            
            // Âú®ÁãÄÊÖãÂçÄÂüüÈ°ØÁ§∫Ë™ûË®ÄÂÅµÊ∏¨ÁµêÊûú
            const tempStatus = document.createElement('div');
            tempStatus.className = 'status success';
            tempStatus.style.fontSize = '14px';
            tempStatus.style.padding = '10px';
            tempStatus.style.marginBottom = '15px';
            tempStatus.textContent = statusMessage;
            
            const container = document.querySelector('.container');
            const configInfo = document.querySelector('.config-info');
            container.insertBefore(tempStatus, configInfo.nextSibling);
            
            // 3ÁßíÂæåËá™ÂãïÁßªÈô§
            setTimeout(() => {
                if (tempStatus.parentNode) {
                    tempStatus.parentNode.removeChild(tempStatus);
                }
            }, 3000);
        }

        // ÂàùÂßãÂåñ Web Audio API
        function initAudioContext() {
            return new Promise((resolve, reject) => {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        resolve();
                    }).catch(reject);
                } else {
                    resolve();
                }
            });
        }

        // ÈñãÂßãÊô∫ËÉΩÂëºÂê∏Áõ£Ê∏¨Ê®°Âºè
        function startAdaptiveMode() {
            initAudioContext().then(() => {
                // Google Analytics ËøΩËπ§
                if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.START_MONITORING) {
                    trackEvent('start_monitoring', {
                        language: currentLanguage,
                        music_type: CONFIG.MUSIC_CONTENT.TYPE
                    });
                }
                
                // ÂèñÂæóÈ∫•ÂÖãÈ¢®Ê¨äÈôê
                return navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: CONFIG.SAMPLE_RATE,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
            }).then(stream => {
                mediaStream = stream;
                
                // Ë®≠ÁΩÆÈü≥Ë®äÂàÜÊûê
                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                
                source.connect(analyser);
                
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                isRecording = true;
                
                // ÂïüÂãïÂëºÂê∏Ê™¢Ê∏¨
                startBreathDetection();
                
                // ÁîüÊàêÂàùÂßãÊãçÈ†ª
                startBinauralBeats();
                
                // ËºâÂÖ•ËÉåÊôØÈü≥Ê™îÔºàÂ¶ÇÊûúÊúâÈÖçÁΩÆÔºâ
                const audioUrl = getBackgroundAudioUrl();
                if (audioUrl) {
                    loadBackgroundAudio(audioUrl);
                }
                
                document.getElementById('startAdaptiveBtn').disabled = true;
                document.getElementById('stopAdaptiveBtn').disabled = false;
                
                const content = getLanguageContent();
                showStatus(content.status.monitoring, 'processing');
                
            }).catch(error => {
                console.error('ÂïüÂãïÂ§±Êïó:', error);
                const content = getLanguageContent();
                showStatus(`${content.status.error}${error.message}`, 'error');
            });
        }

        // ÂÅúÊ≠¢Êô∫ËÉΩÊ®°Âºè
        function stopAdaptiveMode() {
            isRecording = false;
            
            // Google Analytics ËøΩËπ§
            if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.STOP_MONITORING) {
                trackEvent('stop_monitoring', {
                    language: currentLanguage
                });
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            
            // ÂÅúÊ≠¢ÊãçÈ†ª
            stopBinauralBeats();
            
            // ÂÅúÊ≠¢ËÉåÊôØÈü≥Ê®ÇÔºàÂ∏∂Ê∑°Âá∫ÊïàÊûúÔºâ
            if (backgroundAudioSource && backgroundGainNode) {
                const fadeOutDuration = CONFIG.MUSIC_CONTENT.FADE_OUT_DURATION;
                backgroundGainNode.gain.exponentialRampToValueAtTime(
                    0.001, 
                    audioContext.currentTime + fadeOutDuration
                );
                setTimeout(() => {
                    if (backgroundAudioSource) {
                        backgroundAudioSource.stop();
                        backgroundAudioSource = null;
                        backgroundGainNode = null;
                    }
                }, fadeOutDuration * 1000);
            }
            
            document.getElementById('startAdaptiveBtn').disabled = false;
            document.getElementById('stopAdaptiveBtn').disabled = true;
            
            // ÈáçÁΩÆÁµ±Ë®àÈ°ØÁ§∫
            resetStatsDisplay();
            
            const content = getLanguageContent();
            showStatus(content.status.stopped, 'success');
        }                startBinauralBeats();
                
                // ËºâÂÖ•ËÉåÊôØÈü≥Ê™îÔºàÂ¶ÇÊûúÊúâÈÖçÁΩÆÔºâ
                const audioUrl = getBackgroundAudioUrl();
                if (audioUrl) {
                    await loadBackgroundAudio(audioUrl);
                }
                
                document.getElementById('startAdaptiveBtn').disabled = true;
                document.getElementById('stopAdaptiveBtn').disabled = false;
                
                const content = getLanguageContent();
                showStatus(content.status.monitoring, 'processing');
                
            } catch (error) {
                console.error('ÂïüÂãïÂ§±Êïó:', error);
                const content = getLanguageContent();
                showStatus(`${content.status.error}${error.message}`, 'error');
            }
        }

        // ÂÅúÊ≠¢Êô∫ËÉΩÊ®°Âºè
        function stopAdaptiveMode() {
            isRecording = false;
            
            // Google Analytics ËøΩËπ§
            if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.STOP_MONITORING) {
                trackEvent('stop_monitoring', {
                    language: currentLanguage
                });
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            
            // ÂÅúÊ≠¢ÊãçÈ†ª
            stopBinauralBeats();
            
            // ÂÅúÊ≠¢ËÉåÊôØÈü≥Ê®ÇÔºàÂ∏∂Ê∑°Âá∫ÊïàÊûúÔºâ
            if (backgroundAudioSource && backgroundGainNode) {
                const fadeOutDuration = CONFIG.MUSIC_CONTENT.FADE_OUT_DURATION;
                backgroundGainNode.gain.exponentialRampToValueAtTime(
                    0.001, 
                    audioContext.currentTime + fadeOutDuration
                );
                setTimeout(() => {
                    if (backgroundAudioSource) {
                        backgroundAudioSource.stop();
                        backgroundAudioSource = null;
                        backgroundGainNode = null;
                    }
                }, fadeOutDuration * 1000);
            }
            
            document.getElementById('startAdaptiveBtn').disabled = false;
            document.getElementById('stopAdaptiveBtn').disabled = true;
            document.getElementById('breathCircle').classList.remove('breathing');
            
            // ÈáçÁΩÆÁµ±Ë®àÈ°ØÁ§∫
            resetStatsDisplay();
            
            const content = getLanguageContent();
            showStatus(content.status.stopped, 'success');
        }

        // UI ËºîÂä©ÂáΩÊï∏
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        // ÂëºÂê∏Ê™¢Ê∏¨
        function startBreathDetection() {
            const canvas = document.getElementById('waveform');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            let breathingSamples = [];
            let lastBreathTime = Date.now();
            let breathCount = 0;
            
            function detectBreath() {
                if (!isRecording) return;
                
                analyser.getByteTimeDomainData(dataArray);
                
                // Ë®àÁÆóËÉΩÈáè
                let energy = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    const sample = (dataArray[i] - 128) / 128;
                    energy += sample * sample;
                }
                energy = Math.sqrt(energy / dataArray.length);
                
                breathingSamples.push(energy);
                if (breathingSamples.length > 300) { // ‰øùÊåÅÁ¥Ñ10ÁßíÁöÑÊï∏Êìö
                    breathingSamples.shift();
                }
                
                // Áπ™Ë£ΩÊ≥¢ÂΩ¢
                drawWaveform(ctx, canvas, breathingSamples);
                
                // Ê™¢Ê∏¨ÂëºÂê∏Â≥∞ÂÄº
                if (breathingSamples.length > 10) {
                    const recent = breathingSamples.slice(-10);
                    const avgEnergy = recent.reduce((a, b) => a + b) / recent.length;
                    const threshold = Math.max(...breathingSamples) * CONFIG.BREATH_DETECTION_SENSITIVITY;
                    
                    if (energy > threshold && energy > avgEnergy * 1.5) {
                        const now = Date.now();
                        if (now - lastBreathTime > 1000) { // Ëá≥Â∞ë1ÁßíÈñìÈöî
                            breathCount++;
                            lastBreathTime = now;
                            
                            // ÂëºÂê∏Ë¶ñË¶∫ÂåñÂ∑≤ÁßªÈô§Ôºå‰∏çÈúÄË¶ÅÂãïÁï´
                        }
                        }
                    }
                }
                
                // ÊØè5ÁßíË®àÁÆó‰∏ÄÊ¨°ÂëºÂê∏ÈÄüÁéá
                if (breathingSamples.length % 150 === 0) {
                    const breathRate = (breathCount / (breathingSamples.length / 30)) * 60;
                    updateBreathingStats(breathRate);
                    breathCount = Math.floor(breathCount * 0.8); // Ë°∞Ê∏õËàäÊï∏Êìö
                }
                
                requestAnimationFrame(detectBreath);
            }
            
            detectBreath();
        }

        // Áπ™Ë£ΩÊ≥¢ÂΩ¢
        function drawWaveform(ctx, canvas, samples) {
            // Ê∏ÖÈô§Áï´Â∏É
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Áπ™Ë£Ω‰∏≠Á∑ö
            ctx.strokeStyle = '#dee2e6';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
            
            // Áπ™Ë£ΩÊ≥¢ÂΩ¢
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const sliceWidth = canvas.width / samples.length;
            let x = 0;
            
            for (let i = 0; i < samples.length; i++) {
                const y = (samples[i] * canvas.height / 2) + canvas.height / 2;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.stroke();
        }

        // Êõ¥Êñ∞ÂëºÂê∏Áµ±Ë®à
        function updateBreathingStats(breathRate) {
            const content = getLanguageContent();
            document.getElementById('breathRate').textContent = `${breathRate.toFixed(1)} ${content.units.perMin}`;
            
            let state, beatFreq, brainwave, stateKey;
            
            if (breathRate < 10) {
                state = content.states.deep_relaxed;
                stateKey = 'deep_relaxed';
                brainwave = content.waves.delta;
            } else if (breathRate < 15) {
                state = content.states.relaxed;
                stateKey = 'relaxed';
                brainwave = content.waves.theta;
            } else if (breathRate < 20) {
                state = content.states.normal;
                stateKey = 'normal';
                brainwave = content.waves.alpha;
            } else {
                state = content.states.tense;
                stateKey = 'tense';
                brainwave = content.waves.beta;
            }
            
            beatFreq = BEAT_FREQUENCY_MAP[stateKey];
            
            document.getElementById('currentState').textContent = state;
            document.getElementById('brainwaveType').textContent = brainwave;
            
            // Êõ¥Êñ∞ÊãçÈ†ª
            if (beatFreq !== currentBeatFreq) {
                // Google Analytics ËøΩËπ§ÁãÄÊÖãËÆäÂåñ
                if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.BREATH_STATE_CHANGE) {
                    trackEvent('breath_state_change', {
                        from_state: currentBeatFreq,
                        to_state: beatFreq,
                        state_name: stateKey,
                        breath_rate: breathRate,
                        language: currentLanguage
                    });
                }
                
                currentBeatFreq = beatFreq;
                updateBinauralBeats(beatFreq);
            }
        }

        // ÁîüÊàêÊãçÈ†ªÈü≥Ë®ä
        function startBinauralBeats() {
            // Â∑¶ËÄ≥ÊåØÁõ™Âô®
            const leftOsc = audioContext.createOscillator();
            const leftGain = audioContext.createGain();
            leftOsc.type = 'sine';
            leftOsc.frequency.setValueAtTime(CONFIG.BASE_FREQUENCY, audioContext.currentTime);
            leftGain.gain.setValueAtTime(CONFIG.BINAURAL_VOLUME, audioContext.currentTime);
            
            // Âè≥ËÄ≥ÊåØÁõ™Âô®  
            const rightOsc = audioContext.createOscillator();
            const rightGain = audioContext.createGain();
            rightOsc.type = 'sine';
            rightOsc.frequency.setValueAtTime(CONFIG.BASE_FREQUENCY + currentBeatFreq, audioContext.currentTime);
            rightGain.gain.setValueAtTime(CONFIG.BINAURAL_VOLUME, audioContext.currentTime);
            
            // Á´ãÈ´îËÅ≤ÂàÜÈõ¢
            const merger = audioContext.createChannelMerger(2);
            leftOsc.connect(leftGain).connect(merger, 0, 0);
            rightOsc.connect(rightGain).connect(merger, 0, 1);
            merger.connect(audioContext.destination);
            
            leftOsc.start();
            rightOsc.start();
            
            binauralOscillators = [leftOsc, rightOsc, leftGain, rightGain, merger];
        }

        // Êõ¥Êñ∞ÊãçÈ†ªÈ†ªÁéá
        function updateBinauralBeats(newBeatFreq) {
            if (binauralOscillators.length > 0) {
                const rightOsc = binauralOscillators[1];
                rightOsc.frequency.setValueAtTime(CONFIG.BASE_FREQUENCY + newBeatFreq, audioContext.currentTime);
            }
        }

        // ÂÅúÊ≠¢ÊãçÈ†ª
        function stopBinauralBeats() {
            binauralOscillators.forEach(node => {
                if (node.stop) {
                    node.stop();
                } else if (node.disconnect) {
                    node.disconnect();
                }
            });
            binauralOscillators = [];
        }

        // ËºâÂÖ•ËÉåÊôØÈü≥Ê™î
        function loadBackgroundAudio(url) {
            fetch(url).then(response => {
                if (!response.ok) {
                    throw new Error(`ÁÑ°Ê≥ïËºâÂÖ•ËÉåÊôØÈü≥Ê™îÔºö${response.statusText}`);
                }
                return response.arrayBuffer();
            }).then(arrayBuffer => {
                return audioContext.decodeAudioData(arrayBuffer);
            }).then(audioBuffer => {
                backgroundAudioSource = audioContext.createBufferSource();
                backgroundGainNode = audioContext.createGain();
                
                backgroundAudioSource.buffer = audioBuffer;
                backgroundAudioSource.loop = CONFIG.MUSIC_CONTENT.LOOP;
                
                // Ë®≠ÁΩÆÊ∑°ÂÖ•ÊïàÊûú
                const fadeInDuration = CONFIG.MUSIC_CONTENT.FADE_IN_DURATION;
                backgroundGainNode.gain.setValueAtTime(0, audioContext.currentTime);
                backgroundGainNode.gain.exponentialRampToValueAtTime(
                    CONFIG.BACKGROUND_VOLUME, 
                    audioContext.currentTime + fadeInDuration
                );
                
                backgroundAudioSource.connect(backgroundGainNode).connect(audioContext.destination);
                backgroundAudioSource.start();
            }).catch(error => {
                console.warn('ËÉåÊôØÈü≥Ê™îËºâÂÖ•Â§±Êïó:', error);
            });
        }

        // Ë®≠ÂÇôÊ∏¨Ë©¶ÂäüËÉΩ
        function testDevice() {
            const btn = document.getElementById('deviceTestBtn');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Ê∏¨Ë©¶‰∏≠...';
            
            // Ê∏¨Ë©¶È∫•ÂÖãÈ¢®
            navigator.mediaDevices.getUserMedia({ 
                audio: {
                    sampleRate: 16000,
                    channelCount: 1
                } 
            }).then(stream => {
                // Á∞°ÂñÆÊ∏¨Ë©¶Èü≥Ë®äËº∏ÂÖ•
                const testContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = testContext.createMediaStreamSource(stream);
                const testAnalyser = testContext.createAnalyser();
                source.connect(testAnalyser);
                
                const bufferLength = testAnalyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                // Ê∏¨Ë©¶3Áßí
                let maxVolume = 0;
                const testDuration = 3000;
                const startTime = Date.now();
                
                const testInterval = setInterval(() => {
                    testAnalyser.getByteTimeDomainData(dataArray);
                    
                    let volume = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        const sample = Math.abs(dataArray[i] - 128);
                        volume = Math.max(volume, sample);
                    }
                    
                    maxVolume = Math.max(maxVolume, volume);
                    
                    if (Date.now() - startTime > testDuration) {
                        clearInterval(testInterval);
                        stream.getTracks().forEach(track => track.stop());
                        testContext.close();
                        
                        // È°ØÁ§∫Ê∏¨Ë©¶ÁµêÊûú
                        if (maxVolume > 10) {
                            btn.innerHTML = '‚úÖ Ë®≠ÂÇôÊ≠£Â∏∏';
                            btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                        } else {
                            btn.innerHTML = '‚ö†Ô∏è Èü≥ÈáèÈÅé‰Ωé';
                            btn.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
                        }
                        
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                            btn.disabled = false;
                        }, 2000);
                    }
                }, 100);
                
            }).catch(error => {
                console.error('Ë®≠ÂÇôÊ∏¨Ë©¶Â§±Êïó:', error);
                btn.innerHTML = '‚ùå Ê∏¨Ë©¶Â§±Êïó';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    btn.disabled = false;
                }, 2000);
            });
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            // ÂàùÂßãÂåñÈü≥Ê®ÇÂ∫´
            initMusicLibrary();
            
            // ÂàùÂßãÂåñ Google Analytics
            initGoogleAnalytics();
            
            // Ëá™ÂãïÂÅµÊ∏¨Áî®Êà∂Ë™ûË®Ä
            detectUserLanguage().then(() => {
                // Êõ¥Êñ∞Ë™ûË®ÄÂÖßÂÆπ
                updateLanguageContent();
                
                // ÂàùÂßãÂåñÈÖçÁΩÆÈ°ØÁ§∫
                initConfigDisplay();
                
                // È°ØÁ§∫Ë™ûË®ÄÂÅµÊ∏¨ÁãÄÊÖã
                showLanguageDetectionStatus();
            }).catch(error => {
                console.error('Ë™ûË®ÄÂÅµÊ∏¨Â§±Êïó:', error);
                // ‰ΩøÁî®È†êË®≠Ë™ûË®Ä
                updateLanguageContent();
                initConfigDisplay();
            });
            
            // Ë®≠ÁΩÆÊêúÂ∞ãÊ°Ü‰∫ã‰ª∂
            const searchInput = document.getElementById('musicSearchInput');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                if (query.trim()) {
                    const results = searchMusic(query);
                    renderSearchResults(results);
                } else {
                    document.getElementById('searchResults').style.display = 'none';
                }
            });

            // È†ÅÈù¢ÈóúÈñâÊôÇÊ∏ÖÁêÜË≥áÊ∫ê
            window.addEventListener('beforeunload', () => {
                if (isRecording) {
                    stopAdaptiveMode();
                }
            });

            // Ê™¢Êü•ÁÄèË¶ΩÂô®ÊîØÊè¥
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                const content = getLanguageContent();
                showStatus(content.status.unsupported, 'error');
                document.getElementById('startAdaptiveBtn').disabled = true;
                document.getElementById('deviceTestBtn').disabled = true;
            }
        });
    </script>
</body>
</html>
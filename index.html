<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å‘¼å¸æ‹é »è™•ç†å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .adaptive-mode {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }

        .adaptive-mode h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .adaptive-mode p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .adaptive-mode ul {
            margin: 15px 0;
            padding-left: 25px;
        }

        .adaptive-mode li {
            margin: 8px 0;
            color: #666;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .breathing-monitor {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 30px 0;
        }

        .breath-visual {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }

        .breath-visual h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .breath-circle {
            width: 140px;
            height: 140px;
            border: 5px solid #667eea;
            border-radius: 50%;
            margin: 25px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .breath-circle.breathing {
            animation: breathe 3s infinite ease-in-out;
            border-color: #764ba2;
            color: #764ba2;
        }

        @keyframes breathe {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
            }
            50% { 
                transform: scale(1.15); 
                box-shadow: 0 0 0 20px rgba(102, 126, 234, 0);
            }
        }

        .breath-stats {
            background: rgba(118, 75, 162, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .breath-stats h3 {
            color: #764ba2;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .stat-label {
            font-weight: bold;
            color: #555;
        }

        .stat-value {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .waveform {
            width: 100%;
            height: 120px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 20px 0;
            background: white;
        }

        .status {
            margin: 25px 0;
            padding: 18px;
            border-radius: 12px;
            font-weight: bold;
            text-align: center;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .control-buttons {
            text-align: center;
            margin: 30px 0;
        }

        .config-info {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #667eea;
        }

        .config-info h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            color: #666;
        }

        .config-audio-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin: 25px 0;
        }

        .audio-search-section {
            background: rgba(118, 75, 162, 0.1);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #764ba2;
        }

        .audio-search-section h4 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .device-test-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            width: 100%;
        }

        .device-test-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .music-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .music-item:last-child {
            border-bottom: none;
        }

        .music-item:hover {
            background-color: #f8f9fa;
        }

        .music-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #764ba2;
        }

        .music-info {
            flex: 1;
        }

        .music-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .music-description {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .music-badge {
            background: #764ba2;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .current-selection {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .current-selection-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .current-selection-name {
            color: #333;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .breathing-monitor {
                grid-template-columns: 1fr;
            }
            
            .config-audio-container {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§˜ æ™ºèƒ½å‘¼å¸æ‹é »è™•ç†å™¨</h1>
        
        <div class="adaptive-mode">
            <h3>ğŸ¤– æ™ºèƒ½å‘¼å¸ç›£æ¸¬</h3>
            <p>ç³»çµ±æœƒå³æ™‚ç›£æ¸¬ä½ çš„å‘¼å¸ç‹€æ…‹ï¼Œä¸¦è‡ªå‹•èª¿æ•´æ‹é »ä¾†å¼•å°ä½ é€²å…¥ä¸åŒçš„æ„è­˜ç‹€æ…‹ï¼š</p>
            <ul>
                <li><strong>æ·±åº¦æ”¾é¬†</strong> (&lt;10æ¬¡/åˆ†)ï¼šDeltaæ³¢ 4Hz - æ·±åº¦å†¥æƒ³èˆ‡ä¿®å¾©</li>
                <li><strong>æ”¾é¬†ç‹€æ…‹</strong> (10-15æ¬¡/åˆ†)ï¼šThetaæ³¢ 6Hz - å‰µæ„èˆ‡ç›´è¦º</li>
                <li><strong>æ­£å¸¸ç‹€æ…‹</strong> (15-20æ¬¡/åˆ†)ï¼šAlphaæ³¢ 10Hz - å°ˆæ³¨èˆ‡å¹³éœ</li>
                <li><strong>ç·Šå¼µç‹€æ…‹</strong> (&gt;20æ¬¡/åˆ†)ï¼šBetaæ³¢ 14Hz - æå‡å°ˆæ³¨åŠ›</li>
            </ul>
        </div>

        <div class="config-audio-container">
            <div class="audio-search-section">
                <h4 id="audioSearchTitle">ğŸµ èƒŒæ™¯éŸ³æ¨‚æœå°‹</h4>
                <div class="search-container">
                    <input type="text" id="musicSearchInput" class="search-input" placeholder="æœå°‹éŸ³æ¨‚... (ä¾‹å¦‚: æ£®æ—ã€æµ·æµªã€å†¥æƒ³)">
                </div>
                <div id="currentSelection" class="current-selection" style="display: none;">
                    <div class="current-selection-label" id="currentSelectionLabel">ç›®å‰é¸æ“‡</div>
                    <div class="current-selection-name" id="currentSelectionName"></div>
                </div>
                <div id="searchResults" class="search-results" style="display: none;"></div>
            </div>

            <div class="config-info">
                <h4 id="systemConfigTitle">ğŸ”§ ç³»çµ±é…ç½®</h4>
                <div class="config-item">
                    <span>åŸºé »é »ç‡ï¼š</span>
                    <span id="configBaseFreq">200 Hz</span>
                </div>
                <div class="config-item">
                    <span>èƒŒæ™¯éŸ³æª”ï¼š</span>
                    <span id="configAudioFile">ç„¡</span>
                </div>
                <div class="config-item">
                    <span>éŸ³é‡æ¯”ä¾‹ï¼š</span>
                    <span>æ‹é » 30% / èƒŒæ™¯éŸ³ 70%</span>
                </div>
                <button onclick="testDevice()" class="device-test-btn" id="deviceTestBtn">
                    ğŸ¤ è¨­å‚™æ¸¬è©¦
                </button>
            </div>
        </div>

        <div class="breathing-monitor">
            <div class="breath-visual">
                <h3>å‘¼å¸è¦–è¦ºåŒ–</h3>
                <canvas id="waveform" class="waveform"></canvas>
            </div>

            <div class="breath-stats">
                <h3>å³æ™‚æ•¸æ“š</h3>
                <div class="stat-item">
                    <span class="stat-label">å‘¼å¸é€Ÿç‡ï¼š</span>
                    <span class="stat-value" id="breathRate">-- æ¬¡/åˆ†</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ç•¶å‰ç‹€æ…‹ï¼š</span>
                    <span class="stat-value" id="currentState">å¾…æª¢æ¸¬</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">è…¦æ³¢é¡å‹ï¼š</span>
                    <span class="stat-value" id="brainwaveType">--</span>
                </div>
            </div>
        </div>

        <div class="control-buttons">
            <button onclick="startAdaptiveMode()" id="startAdaptiveBtn">ğŸ™ï¸ é–‹å§‹å‘¼å¸ç›£æ¸¬</button>
            <button onclick="stopAdaptiveMode()" id="stopAdaptiveBtn" disabled>â¹ï¸ åœæ­¢ç›£æ¸¬</button>
        </div>

        <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
        // ===== é–‹ç™¼è€…é…ç½®å€åŸŸ =====
        const CONFIG = {
            // éŸ³è¨Šè¨­å®š
            BASE_FREQUENCY: 200,              // åŸºé » (Hz)
            BINAURAL_VOLUME: 0.3,            // æ‹é »éŸ³é‡ (0.0-1.0)
            BACKGROUND_VOLUME: 0.7,          // èƒŒæ™¯éŸ³éŸ³é‡ (0.0-1.0)
            SAMPLE_RATE: 16000,              // å–æ¨£ç‡
            ANALYSIS_DURATION: 10,           // åˆ†ææ™‚é–“é•·åº¦ (ç§’)
            BREATH_DETECTION_SENSITIVITY: 0.7, // å‘¼å¸æª¢æ¸¬æ•æ„Ÿåº¦ (0.0-1.0)
            
            // èªè¨€è¨­å®š
            LANGUAGE: 'auto',                // 'auto' ç‚ºè‡ªå‹•åµæ¸¬ï¼Œæˆ–æŒ‡å®š 'zh-TW', 'zh-CN', 'en', 'ja', 'ko'
            FALLBACK_LANGUAGE: 'zh-TW',      // è‡ªå‹•åµæ¸¬å¤±æ•—æ™‚çš„é è¨­èªè¨€
            
            // IPinfo åœ°ç†ä½ç½®åµæ¸¬è¨­å®š
            IPINFO: {
                API_TOKEN: '',               // IPinfo API Token (å¯ç•™ç©ºä½¿ç”¨å…è²»é¡åº¦)
                ENABLE_AUTO_LANGUAGE: true,  // æ˜¯å¦å•Ÿç”¨æ ¹æ“šåœ°ç†ä½ç½®è‡ªå‹•åˆ‡æ›èªè¨€
                TIMEOUT: 5000               // API è«‹æ±‚è¶…æ™‚æ™‚é–“ (æ¯«ç§’)
            },
            
            // Google Analytics è¨­å®š
            GOOGLE_ANALYTICS: {
                GA_ID: '',                    // GA4 æ¸¬é‡ID (ä¾‹: 'G-XXXXXXXXXX')
                ENABLE_TRACKING: false,       // æ˜¯å¦å•Ÿç”¨è¿½è¹¤
                TRACK_EVENTS: {
                    START_MONITORING: true,   // è¿½è¹¤é–‹å§‹ç›£æ¸¬äº‹ä»¶
                    STOP_MONITORING: true,    // è¿½è¹¤åœæ­¢ç›£æ¸¬äº‹ä»¶
                    BREATH_STATE_CHANGE: true, // è¿½è¹¤å‘¼å¸ç‹€æ…‹è®ŠåŒ–äº‹ä»¶
                    LANGUAGE_DETECTION: true  // è¿½è¹¤èªè¨€åµæ¸¬äº‹ä»¶
                }
            },
            
            // éŸ³æ¨‚å…§å®¹é¸æ“‡
            MUSIC_CONTENT: {
                TYPE: 'nature',              // 'nature', 'ambient', 'meditation', 'white_noise', 'custom'
                CUSTOM_URL: '',              // ç•¶ TYPE ç‚º 'custom' æ™‚ä½¿ç”¨çš„è‡ªè¨‚URL
                LOOP: true,                  // æ˜¯å¦å¾ªç’°æ’­æ”¾
                FADE_IN_DURATION: 3,         // æ·¡å…¥æ™‚é–“ (ç§’)
                FADE_OUT_DURATION: 3         // æ·¡å‡ºæ™‚é–“ (ç§’)
            }
        };

        // åœ‹å®¶ä»£ç¢¼å°æ‡‰èªè¨€æ˜ å°„
        const COUNTRY_LANGUAGE_MAP = {
            'TW': 'zh-TW',      // å°ç£ -> ç¹é«”ä¸­æ–‡
            'HK': 'zh-TW',      // é¦™æ¸¯ -> ç¹é«”ä¸­æ–‡
            'MO': 'zh-TW',      // æ¾³é–€ -> ç¹é«”ä¸­æ–‡
            'CN': 'zh-CN',      // ä¸­åœ‹ -> ç°¡é«”ä¸­æ–‡
            'SG': 'zh-CN',      // æ–°åŠ å¡ -> ç°¡é«”ä¸­æ–‡ (è¯èªç”¨æˆ¶è¼ƒå¤šä½¿ç”¨ç°¡é«”)
            'US': 'en',         // ç¾åœ‹ -> è‹±æ–‡
            'GB': 'en',         // è‹±åœ‹ -> è‹±æ–‡
            'CA': 'en',         // åŠ æ‹¿å¤§ -> è‹±æ–‡
            'AU': 'en',         // æ¾³æ´² -> è‹±æ–‡
            'NZ': 'en',         // ç´è¥¿è˜­ -> è‹±æ–‡
            'IN': 'en',         // å°åº¦ -> è‹±æ–‡
            'JP': 'ja',         // æ—¥æœ¬ -> æ—¥æ–‡
            'KR': 'ko'          // éŸ“åœ‹ -> éŸ“æ–‡
        };

        // é è¨­éŸ³æ¨‚åº«
        const MUSIC_LIBRARY = {
            nature: [
                { 
                    name: 'æ£®æ—é›¨è²', 
                    name_en: 'Forest Rain',
                    url: 'https://cdn.pixabay.com/audio/2022/03/10/audio_2f2e3908a4.mp3',
                    keywords: ['æ£®æ—', 'é›¨è²', 'ä¸‹é›¨', 'æ¨¹æ—', 'forest', 'rain', 'trees', 'senlin', 'yusheng', 'xiaoyu'],
                    description: 'æ·±æ—ä¸­çš„ç´°é›¨è²ï¼Œå¸¶ä¾†å¯§éœæ”¾é¬†çš„æ„Ÿå—'
                },
                { 
                    name: 'æµ·æµªè²', 
                    name_en: 'Ocean Waves',
                    url: 'https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3',
                    keywords: ['æµ·æµª', 'æµ·æ´‹', 'æ³¢æµª', 'æµ·é‚Š', 'ocean', 'waves', 'sea', 'beach', 'hailang', 'haiyang', 'bolang'],
                    description: 'æº«æŸ”çš„æµ·æµªæ‹æ‰“è²ï¼Œæ¨¡æ“¬æµ·é‚Šçš„å¯§éœæ°›åœ'
                },
                { 
                    name: 'é³¥é³´è²', 
                    name_en: 'Bird Songs',
                    url: 'https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c7a7ce.mp3',
                    keywords: ['é³¥é³´', 'é³¥å«', 'é³¥è²', 'è‡ªç„¶', 'birds', 'singing', 'chirping', 'niaomine', 'niaojiao', 'ziran'],
                    description: 'æ¸…æ™¨é³¥å…’çš„æ‚…è€³æ­Œè²ï¼Œå……æ»¿ç”Ÿæ©Ÿèˆ‡æ´»åŠ›'
                }
            ],
            ambient: [
                { 
                    name: 'ç’°å¢ƒéŸ³æ¨‚', 
                    name_en: 'Ambient Music',
                    url: 'https://cdn.pixabay.com/audio/2022/02/11/audio_8be2d3a1c8.mp3',
                    keywords: ['ç’°å¢ƒ', 'æ°›åœ', 'èƒŒæ™¯', 'éŸ³æ¨‚', 'ambient', 'atmosphere', 'background', 'huanjing', 'fenwei', 'beinjing'],
                    description: 'æŸ”å’Œçš„ç’°å¢ƒéŸ³æ¨‚ï¼Œå‰µé€ èˆ’é©çš„èƒŒæ™¯æ°›åœ'
                },
                { 
                    name: 'å¤ªç©ºéŸ³æ¨‚', 
                    name_en: 'Space Music',
                    url: 'https://cdn.pixabay.com/audio/2021/12/06/audio_2b1e9d4c5a.mp3',
                    keywords: ['å¤ªç©º', 'å®‡å®™', 'æ˜Ÿç©º', 'ç§‘å¹»', 'space', 'cosmic', 'universe', 'sci-fi', 'taikong', 'yuzhou', 'xingkong'],
                    description: 'ç¥ç§˜çš„å¤ªç©ºéŸ³æ•ˆï¼Œå¸¶ä¾†ç„¡é™æƒ³åƒç©ºé–“'
                }
            ],
            meditation: [
                { 
                    name: 'å†¥æƒ³éŸ³æ¨‚', 
                    name_en: 'Meditation Music',
                    url: 'https://cdn.pixabay.com/audio/2022/01/18/audio_7d5c8f9b2e.mp3',
                    keywords: ['å†¥æƒ³', 'éœå¿ƒ', 'ç¦ªä¿®', 'æ”¾é¬†', 'meditation', 'mindfulness', 'zen', 'relax', 'mingxiang', 'jingxin', 'chanxiu'],
                    description: 'å°ˆç‚ºå†¥æƒ³è¨­è¨ˆçš„å¯§éœéŸ³æ¨‚ï¼Œå¹«åŠ©æ·±åº¦æ”¾é¬†'
                },
                { 
                    name: 'ç™‚ç™’éŸ³æ¨‚', 
                    name_en: 'Healing Music',
                    url: 'https://cdn.pixabay.com/audio/2021/11/21/audio_4a8c9e7f1b.mp3',
                    keywords: ['ç™‚ç™’', 'æ²»ç™‚', 'ä¿®å¾©', 'èˆ’ç·©', 'healing', 'therapy', 'soothing', 'recovery', 'liaoyu', 'zhiliao', 'shufu'],
                    description: 'å…·æœ‰ç™‚ç™’æ•ˆæœçš„éŸ³æ¨‚ï¼Œæ’«æ…°å¿ƒéˆå‰µå‚·'
                }
            ],
            white_noise: [
                { 
                    name: 'ç™½å™ªéŸ³', 
                    name_en: 'White Noise',
                    url: 'https://cdn.pixabay.com/audio/2022/06/15/audio_9c3f2a8d7e.mp3',
                    keywords: ['ç™½å™ªéŸ³', 'å™ªéŸ³', 'å°ˆæ³¨', 'é®è”½', 'white noise', 'focus', 'masking', 'baizaoyin', 'zhuanzhu', 'zhebei'],
                    description: 'å‡å‹»çš„ç™½å™ªéŸ³ï¼Œå¹«åŠ©å°ˆæ³¨å’Œé®è”½å¤–ç•Œå¹²æ“¾'
                },
                { 
                    name: 'ç²‰ç´…å™ªéŸ³', 
                    name_en: 'Pink Noise',
                    url: 'https://cdn.pixabay.com/audio/2021/09/30/audio_6b5e1f4a9c.mp3',
                    keywords: ['ç²‰ç´…å™ªéŸ³', 'ç¡çœ ', 'æ·±å±¤', 'ä¼‘æ¯', 'pink noise', 'sleep', 'deep', 'rest', 'fenhongzaoyin', 'shuimian', 'xiuxi'],
                    description: 'æº«å’Œçš„ç²‰ç´…å™ªéŸ³ï¼Œä¿ƒé€²æ·±å±¤ç¡çœ å“è³ª'
                }
            ]
        };

        // æ‹é »é…ç½®å°æ‡‰è¡¨
        const BEAT_FREQUENCY_MAP = {
            'deep_relaxed': 4,    // æ·±åº¦æ”¾é¬† - Deltaæ³¢
            'relaxed': 6,         // æ”¾é¬†ç‹€æ…‹ - Thetaæ³¢  
            'normal': 10,         // æ­£å¸¸ç‹€æ…‹ - Alphaæ³¢
            'tense': 14           // ç·Šå¼µç‹€æ…‹ - Betaæ³¢
        };

        // å¤šåœ‹èªè¨€å…§å®¹
        const LANGUAGE_CONTENT = {
            'zh-TW': {
                title: 'ğŸ§˜ æ™ºèƒ½å‘¼å¸æ‹é »è™•ç†å™¨',
                subtitle: 'ğŸ¤– æ™ºèƒ½å‘¼å¸ç›£æ¸¬',
                description: 'ç³»çµ±æœƒå³æ™‚ç›£æ¸¬ä½ çš„å‘¼å¸ç‹€æ…‹ï¼Œä¸¦è‡ªå‹•èª¿æ•´æ‹é »ä¾†å¼•å°ä½ é€²å…¥ä¸åŒçš„æ„è­˜ç‹€æ…‹ï¼š',
                states: {
                    deep_relaxed: 'æ·±åº¦æ”¾é¬†',
                    relaxed: 'æ”¾é¬†ç‹€æ…‹', 
                    normal: 'æ­£å¸¸ç‹€æ…‹',
                    tense: 'ç·Šå¼µç‹€æ…‹'
                },
                stateDescriptions: {
                    deep_relaxed: '(&lt;10æ¬¡/åˆ†)ï¼šDeltaæ³¢ 4Hz - æ·±åº¦å†¥æƒ³èˆ‡ä¿®å¾©',
                    relaxed: '(10-15æ¬¡/åˆ†)ï¼šThetaæ³¢ 6Hz - å‰µæ„èˆ‡ç›´è¦º',
                    normal: '(15-20æ¬¡/åˆ†)ï¼šAlphaæ³¢ 10Hz - å°ˆæ³¨èˆ‡å¹³éœ',
                    tense: '(&gt;20æ¬¡/åˆ†)ï¼šBetaæ³¢ 14Hz - æå‡å°ˆæ³¨åŠ›'
                },
                labels: {
                    breathRate: 'å‘¼å¸é€Ÿç‡ï¼š',
                    currentState: 'ç•¶å‰ç‹€æ…‹ï¼š',
                    beatFreq: 'æ‹é »é »ç‡ï¼š',
                    brainwave: 'è…¦æ³¢é¡å‹ï¼š',
                    baseFreq: 'åŸºé »é »ç‡ï¼š',
                    audioFile: 'èƒŒæ™¯éŸ³æª”ï¼š',
                    volumeRatio: 'éŸ³é‡æ¯”ä¾‹ï¼š',
                    breathVisual: 'å‘¼å¸è¦–è¦ºåŒ–',
                    realTimeData: 'å³æ™‚æ•¸æ“š',
                    systemConfig: 'ğŸ”§ ç³»çµ±é…ç½®',
                    audioSearch: 'ğŸµ èƒŒæ™¯éŸ³æ¨‚æœå°‹',
                    searchPlaceholder: 'æœå°‹éŸ³æ¨‚... (ä¾‹å¦‚: æ£®æ—ã€æµ·æµªã€å†¥æƒ³)',
                    noResults: 'æ‰¾ä¸åˆ°ç›¸é—œéŸ³æ¨‚',
                    currentMusic: 'ç›®å‰é¸æ“‡',
                    deviceTest: 'è¨­å‚™æ¸¬è©¦'
                },
                buttons: {
                    start: 'ğŸ™ï¸ é–‹å§‹å‘¼å¸ç›£æ¸¬',
                    stop: 'â¹ï¸ åœæ­¢ç›£æ¸¬'
                },
                status: {
                    monitoring: 'ğŸ™ï¸ å‘¼å¸ç›£æ¸¬ä¸­... è«‹ä¿æŒè‡ªç„¶å‘¼å¸',
                    stopped: 'ç›£æ¸¬å·²åœæ­¢',
                    error: 'âŒ ç„¡æ³•å•Ÿå‹•ï¼š',
                    unsupported: 'âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éº¥å…‹é¢¨åŠŸèƒ½ï¼Œç„¡æ³•ä½¿ç”¨å‘¼å¸ç›£æ¸¬',
                    waiting: 'å¾…æª¢æ¸¬'
                },
                units: {
                    perMin: 'æ¬¡/åˆ†',
                    hz: 'Hz',
                    none: 'ç„¡'
                },
                waves: {
                    delta: 'Deltaæ³¢',
                    theta: 'Thetaæ³¢', 
                    alpha: 'Alphaæ³¢',
                    beta: 'Betaæ³¢'
                }
            },
            'zh-CN': {
                title: 'ğŸ§˜ æ™ºèƒ½å‘¼å¸æ‹é¢‘å¤„ç†å™¨',
                subtitle: 'ğŸ¤– æ™ºèƒ½å‘¼å¸ç›‘æµ‹',
                description: 'ç³»ç»Ÿä¼šå®æ—¶ç›‘æµ‹ä½ çš„å‘¼å¸çŠ¶æ€ï¼Œå¹¶è‡ªåŠ¨è°ƒæ•´æ‹é¢‘æ¥å¼•å¯¼ä½ è¿›å…¥ä¸åŒçš„æ„è¯†çŠ¶æ€ï¼š',
                states: {
                    deep_relaxed: 'æ·±åº¦æ”¾æ¾',
                    relaxed: 'æ”¾æ¾çŠ¶æ€',
                    normal: 'æ­£å¸¸çŠ¶æ€', 
                    tense: 'ç´§å¼ çŠ¶æ€'
                },
                stateDescriptions: {
                    deep_relaxed: '(&lt;10æ¬¡/åˆ†)ï¼šDeltaæ³¢ 4Hz - æ·±åº¦å†¥æƒ³ä¸ä¿®å¤',
                    relaxed: '(10-15æ¬¡/åˆ†)ï¼šThetaæ³¢ 6Hz - åˆ›æ„ä¸ç›´è§‰',
                    normal: '(15-20æ¬¡/åˆ†)ï¼šAlphaæ³¢ 10Hz - ä¸“æ³¨ä¸å¹³é™',
                    tense: '(&gt;20æ¬¡/åˆ†)ï¼šBetaæ³¢ 14Hz - æå‡ä¸“æ³¨åŠ›'
                },
                labels: {
                    breathRate: 'å‘¼å¸é€Ÿç‡ï¼š',
                    currentState: 'å½“å‰çŠ¶æ€ï¼š',
                    beatFreq: 'æ‹é¢‘é¢‘ç‡ï¼š',
                    brainwave: 'è„‘æ³¢ç±»å‹ï¼š',
                    baseFreq: 'åŸºé¢‘é¢‘ç‡ï¼š',
                    audioFile: 'èƒŒæ™¯éŸ³æ¡£ï¼š',
                    volumeRatio: 'éŸ³é‡æ¯”ä¾‹ï¼š',
                    breathVisual: 'å‘¼å¸å¯è§†åŒ–',
                    realTimeData: 'å®æ—¶æ•°æ®',
                    systemConfig: 'ğŸ”§ ç³»ç»Ÿé…ç½®',
                    audioSearch: 'ğŸµ èƒŒæ™¯éŸ³ä¹æœå¯»',
                    searchPlaceholder: 'æœå¯»éŸ³ä¹... (ä¾‹å¦‚: æ£®æ—ã€æµ·æµªã€å†¥æƒ³)',
                    noResults: 'æ‰¾ä¸åˆ°ç›¸å…³éŸ³ä¹',
                    currentMusic: 'ç›®å‰é€‰æ‹©',
                    deviceTest: 'è®¾å¤‡æµ‹è¯•'
                },
                buttons: {
                    start: 'ğŸ™ï¸ å¼€å§‹å‘¼å¸ç›‘æµ‹',
                    stop: 'â¹ï¸ åœæ­¢ç›‘æµ‹'
                },
                status: {
                    monitoring: 'ğŸ™ï¸ å‘¼å¸ç›‘æµ‹ä¸­... è¯·ä¿æŒè‡ªç„¶å‘¼å¸',
                    stopped: 'ç›‘æµ‹å·²åœæ­¢',
                    error: 'âŒ æ— æ³•å¯åŠ¨ï¼š',
                    unsupported: 'âš ï¸ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£åŠŸèƒ½ï¼Œæ— æ³•ä½¿ç”¨å‘¼å¸ç›‘æµ‹',
                    waiting: 'å¾…æ£€æµ‹'
                },
                units: {
                    perMin: 'æ¬¡/åˆ†',
                    hz: 'Hz',
                    none: 'æ— '
                },
                waves: {
                    delta: 'Deltaæ³¢',
                    theta: 'Thetaæ³¢',
                    alpha: 'Alphaæ³¢', 
                    beta: 'Betaæ³¢'
                }
            },
            'en': {
                title: 'ğŸ§˜ Smart Breathing Binaural Processor',
                subtitle: 'ğŸ¤– Smart Breathing Monitor',
                description: 'The system monitors your breathing patterns in real-time and automatically adjusts binaural beats to guide you into different states of consciousness:',
                states: {
                    deep_relaxed: 'Deep Relaxed',
                    relaxed: 'Relaxed',
                    normal: 'Normal',
                    tense: 'Tense'
                },
                stateDescriptions: {
                    deep_relaxed: '(&lt;10/min): Delta 4Hz - Deep meditation & restoration',
                    relaxed: '(10-15/min): Theta 6Hz - Creativity & intuition',
                    normal: '(15-20/min): Alpha 10Hz - Focus & calm',
                    tense: '(&gt;20/min): Beta 14Hz - Enhanced concentration'
                },
                labels: {
                    breathRate: 'Breath Rate:',
                    currentState: 'Current State:',
                    beatFreq: 'Beat Frequency:',
                    brainwave: 'Brainwave:',
                    baseFreq: 'Base Frequency:',
                    audioFile: 'Background Audio:',
                    volumeRatio: 'Volume Ratio:',
                    breathVisual: 'Breath Visualization',
                    realTimeData: 'Real-time Data',
                    systemConfig: 'ğŸ”§ System Configuration',
                    audioSearch: 'ğŸµ Background Music Search',
                    searchPlaceholder: 'Search music... (e.g: forest, ocean, meditation)',
                    noResults: 'No matching music found',
                    currentMusic: 'Currently Selected',
                    deviceTest: 'Device Test'
                },
                buttons: {
                    start: 'ğŸ™ï¸ Start Monitoring',
                    stop: 'â¹ï¸ Stop Monitoring'
                },
                status: {
                    monitoring: 'ğŸ™ï¸ Monitoring breathing... Please breathe naturally',
                    stopped: 'Monitoring stopped',
                    error: 'âŒ Failed to start:',
                    unsupported: 'âš ï¸ Your browser does not support microphone access',
                    waiting: 'Waiting'
                },
                units: {
                    perMin: '/min',
                    hz: 'Hz',
                    none: 'None'
                },
                waves: {
                    delta: 'Delta',
                    theta: 'Theta',
                    alpha: 'Alpha',
                    beta: 'Beta'
                }
            },
            'ja': {
                title: 'ğŸ§˜ ã‚¹ãƒãƒ¼ãƒˆå‘¼å¸ãƒã‚¤ãƒãƒ¼ãƒ©ãƒ«ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼',
                subtitle: 'ğŸ¤– ã‚¹ãƒãƒ¼ãƒˆå‘¼å¸ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°',
                description: 'ã‚·ã‚¹ãƒ†ãƒ ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å‘¼å¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç›£è¦–ã—ã€ç•°ãªã‚‹æ„è­˜çŠ¶æ…‹ã«å°ããŸã‚ã«ãƒã‚¤ãƒãƒ¼ãƒ©ãƒ«ãƒ“ãƒ¼ãƒˆã‚’è‡ªå‹•èª¿æ•´ã—ã¾ã™ï¼š',
                states: {
                    deep_relaxed: 'æ·±ã„ãƒªãƒ©ãƒƒã‚¯ã‚¹',
                    relaxed: 'ãƒªãƒ©ãƒƒã‚¯ã‚¹',
                    normal: 'é€šå¸¸',
                    tense: 'ç·Šå¼µ'
                },
                stateDescriptions: {
                    deep_relaxed: '(&lt;10å›/åˆ†)ï¼šãƒ‡ãƒ«ã‚¿æ³¢ 4Hz - æ·±ã„ç‘æƒ³ã¨å›å¾©',
                    relaxed: '(10-15å›/åˆ†)ï¼šã‚·ãƒ¼ã‚¿æ³¢ 6Hz - å‰µé€ æ€§ã¨ç›´æ„Ÿ',
                    normal: '(15-20å›/åˆ†)ï¼šã‚¢ãƒ«ãƒ•ã‚¡æ³¢ 10Hz - é›†ä¸­ã¨å¹³é™',
                    tense: '(&gt;20å›/åˆ†)ï¼šãƒ™ãƒ¼ã‚¿æ³¢ 14Hz - é›†ä¸­åŠ›å‘ä¸Š'
                },
                labels: {
                    breathRate: 'å‘¼å¸æ•°ï¼š',
                    currentState: 'ç¾åœ¨ã®çŠ¶æ…‹ï¼š',
                    beatFreq: 'ãƒ“ãƒ¼ãƒˆå‘¨æ³¢æ•°ï¼š',
                    brainwave: 'è„³æ³¢ï¼š',
                    baseFreq: 'åŸºæœ¬å‘¨æ³¢æ•°ï¼š',
                    audioFile: 'ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰éŸ³å£°ï¼š',
                    volumeRatio: 'éŸ³é‡æ¯”ï¼š',
                    breathVisual: 'å‘¼å¸å¯è¦–åŒ–',
                    realTimeData: 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿',
                    systemConfig: 'ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š',
                    audioSearch: 'ğŸµ èƒŒæ™¯éŸ³æ¥½æ¤œç´¢',
                    searchPlaceholder: 'éŸ³æ¥½ã‚’æ¤œç´¢... (ä¾‹: æ£®ã€æµ·ã€ç‘æƒ³)',
                    noResults: 'è©²å½“ã™ã‚‹éŸ³æ¥½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                    currentMusic: 'ç¾åœ¨é¸æŠä¸­',
                    deviceTest: 'ãƒ‡ãƒã‚¤ã‚¹ãƒ†ã‚¹ãƒˆ'
                },
                buttons: {
                    start: 'ğŸ™ï¸ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é–‹å§‹',
                    stop: 'â¹ï¸ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°åœæ­¢'
                },
                status: {
                    monitoring: 'ğŸ™ï¸ å‘¼å¸ã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ä¸­... è‡ªç„¶ã«å‘¼å¸ã—ã¦ãã ã•ã„',
                    stopped: 'ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãŒåœæ­¢ã—ã¾ã—ãŸ',
                    error: 'âŒ é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸï¼š',
                    unsupported: 'âš ï¸ ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“',
                    waiting: 'å¾…æ©Ÿä¸­'
                },
                units: {
                    perMin: 'å›/åˆ†',
                    hz: 'Hz',
                    none: 'ãªã—'
                },
                waves: {
                    delta: 'ãƒ‡ãƒ«ã‚¿æ³¢',
                    theta: 'ã‚·ãƒ¼ã‚¿æ³¢',
                    alpha: 'ã‚¢ãƒ«ãƒ•ã‚¡æ³¢',
                    beta: 'ãƒ™ãƒ¼ã‚¿æ³¢'
                }
            },
            'ko': {
                title: 'ğŸ§˜ ìŠ¤ë§ˆíŠ¸ í˜¸í¡ ë°”ì´ë…¸ëŸ´ í”„ë¡œì„¸ì„œ',
                subtitle: 'ğŸ¤– ìŠ¤ë§ˆíŠ¸ í˜¸í¡ ëª¨ë‹ˆí„°ë§',
                description: 'ì‹œìŠ¤í…œì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í˜¸í¡ íŒ¨í„´ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ë‹¤ì–‘í•œ ì˜ì‹ ìƒíƒœë¡œ ì•ˆë‚´í•˜ê¸° ìœ„í•´ ë°”ì´ë…¸ëŸ´ ë¹„íŠ¸ë¥¼ ìë™ ì¡°ì •í•©ë‹ˆë‹¤:',
                states: {
                    deep_relaxed: 'ê¹Šì€ ì´ì™„',
                    relaxed: 'ì´ì™„',
                    normal: 'ì •ìƒ',
                    tense: 'ê¸´ì¥'
                },
                stateDescriptions: {
                    deep_relaxed: '(&lt;10íšŒ/ë¶„): ë¸íƒ€íŒŒ 4Hz - ê¹Šì€ ëª…ìƒê³¼ íšŒë³µ',
                    relaxed: '(10-15íšŒ/ë¶„): ì„¸íƒ€íŒŒ 6Hz - ì°½ì˜ì„±ê³¼ ì§ê°',
                    normal: '(15-20íšŒ/ë¶„): ì•ŒíŒŒíŒŒ 10Hz - ì§‘ì¤‘ê³¼ í‰ì˜¨',
                    tense: '(&gt;20íšŒ/ë¶„): ë² íƒ€íŒŒ 14Hz - ì§‘ì¤‘ë ¥ í–¥ìƒ'
                },
                labels: {
                    breathRate: 'í˜¸í¡ ì†ë„:',
                    currentState: 'í˜„ì¬ ìƒíƒœ:',
                    beatFreq: 'ë¹„íŠ¸ ì£¼íŒŒìˆ˜:',
                    brainwave: 'ë‡ŒíŒŒ:',
                    baseFreq: 'ê¸°ë³¸ ì£¼íŒŒìˆ˜:',
                    audioFile: 'ë°°ê²½ ì˜¤ë””ì˜¤:',
                    volumeRatio: 'ë³¼ë¥¨ ë¹„ìœ¨:',
                    breathVisual: 'í˜¸í¡ ì‹œê°í™”',
                    realTimeData: 'ì‹¤ì‹œê°„ ë°ì´í„°',
                    systemConfig: 'ğŸ”§ ì‹œìŠ¤í…œ êµ¬ì„±',
                    audioSearch: 'ğŸµ ë°°ê²½ìŒì•… ê²€ìƒ‰',
                    searchPlaceholder: 'ìŒì•… ê²€ìƒ‰... (ì˜ˆ: ìˆ², ë°”ë‹¤, ëª…ìƒ)',
                    noResults: 'ì¼ì¹˜í•˜ëŠ” ìŒì•…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ',
                    currentMusic: 'í˜„ì¬ ì„ íƒë¨',
                    deviceTest: 'ì¥ì¹˜ í…ŒìŠ¤íŠ¸'
                },
                buttons: {
                    start: 'ğŸ™ï¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘',
                    stop: 'â¹ï¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€'
                },
                status: {
                    monitoring: 'ğŸ™ï¸ í˜¸í¡ ëª¨ë‹ˆí„°ë§ ì¤‘... ìì—°ìŠ¤ëŸ½ê²Œ í˜¸í¡í•˜ì„¸ìš”',
                    stopped: 'ëª¨ë‹ˆí„°ë§ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤',
                    error: 'âŒ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:',
                    unsupported: 'âš ï¸ ë¸Œë¼ìš°ì €ê°€ ë§ˆì´í¬ ì•¡ì„¸ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤',
                    waiting: 'ëŒ€ê¸° ì¤‘'
                },
                units: {
                    perMin: 'íšŒ/ë¶„',
                    hz: 'Hz',
                    none: 'ì—†ìŒ'
                },
                waves: {
                    delta: 'ë¸íƒ€íŒŒ',
                    theta: 'ì„¸íƒ€íŒŒ',
                    alpha: 'ì•ŒíŒŒíŒŒ',
                    beta: 'ë² íƒ€íŒŒ'
                }
            }
        };
        // ===== é…ç½®å€åŸŸçµæŸ =====

        let audioContext;
        let isRecording = false;
        let mediaStream;
        let analyser;
        let dataArray;
        let binauralOscillators = [];
        let backgroundAudioSource;
        let backgroundGainNode;
        let currentBeatFreq = 8;
        let currentLanguage = CONFIG.FALLBACK_LANGUAGE;
        let gaInitialized = false;
        let userCountry = null;
        let selectedMusicItem = null;
        let allMusicItems = [];

        // åˆå§‹åŒ–éŸ³æ¨‚æ¸…å–®
        function initMusicLibrary() {
            allMusicItems = [];
            Object.keys(MUSIC_LIBRARY).forEach(category => {
                MUSIC_LIBRARY[category].forEach(item => {
                    allMusicItems.push({
                        ...item,
                        category: category
                    });
                });
            });
        }

        // æ¨¡ç³Šæœå°‹ç®—æ³• (æ”¯æ´æ‹¼éŸ³å’ŒéŒ¯å­—)
        function fuzzySearch(query, text) {
            if (!query || !text) return 0;
            
            query = query.toLowerCase();
            text = text.toLowerCase();
            
            // å®Œå…¨åŒ¹é…å¾—åˆ†æœ€é«˜
            if (text.includes(query)) return 100;
            
            // è¨ˆç®—ç·¨è¼¯è·é›¢ (Levenshtein distance)
            const editDistance = calculateEditDistance(query, text);
            const maxLen = Math.max(query.length, text.length);
            const similarity = ((maxLen - editDistance) / maxLen) * 100;
            
            return similarity;
        }

        // è¨ˆç®—ç·¨è¼¯è·é›¢
        function calculateEditDistance(a, b) {
            const matrix = [];
            
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[b.length][a.length];
        }

        // èªæ„æœå°‹éŸ³æ¨‚
        function searchMusic(query) {
            if (!query.trim()) return [];
            
            const results = [];
            
            allMusicItems.forEach(item => {
                let maxScore = 0;
                
                // æœå°‹éŸ³æ¨‚åç¨±
                const nameScore = Math.max(
                    fuzzySearch(query, item.name),
                    fuzzySearch(query, item.name_en)
                );
                maxScore = Math.max(maxScore, nameScore);
                
                // æœå°‹é—œéµå­—
                item.keywords.forEach(keyword => {
                    const keywordScore = fuzzySearch(query, keyword);
                    maxScore = Math.max(maxScore, keywordScore);
                });
                
                // æœå°‹æè¿°
                const descScore = fuzzySearch(query, item.description);
                maxScore = Math.max(maxScore, descScore * 0.7); // æè¿°æ¬Šé‡è¼ƒä½
                
                // æœå°‹åˆ†é¡
                const categoryScore = fuzzySearch(query, item.category);
                maxScore = Math.max(maxScore, categoryScore * 0.5); // åˆ†é¡æ¬Šé‡æœ€ä½
                
                if (maxScore > 30) { // è¨­å®šæœ€ä½ç›¸ä¼¼åº¦é–€æª»
                    results.push({
                        ...item,
                        score: maxScore
                    });
                }
            });
            
            // æŒ‰åˆ†æ•¸æ’åº
            return results.sort((a, b) => b.score - a.score);
        }

        // æ¸²æŸ“æœå°‹çµæœ
        function renderSearchResults(results) {
            const content = getLanguageContent();
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = `<div class="no-results">${content.labels.noResults}</div>`;
                container.style.display = 'block';
                return;
            }
            
            let html = '';
            results.forEach((item, index) => {
                const isSelected = selectedMusicItem && selectedMusicItem.url === item.url;
                html += `
                    <div class="music-item ${isSelected ? 'selected' : ''}" data-index="${index}">
                        <div class="music-info">
                            <div class="music-name">${item.name} / ${item.name_en}</div>
                            <div class="music-description">${item.description}</div>
                        </div>
                        <div class="music-badge">${item.category}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.style.display = 'block';
            
            // æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨
            container.querySelectorAll('.music-item').forEach((element, index) => {
                element.addEventListener('click', () => {
                    const item = results[index];
                    selectMusic(item.url, item.name, item.category);
                });
            });
        }

        // é¸æ“‡éŸ³æ¨‚
        function selectMusic(url, name, category) {
            selectedMusicItem = { url, name, category };
            
            // æ›´æ–°é…ç½®
            CONFIG.MUSIC_CONTENT.TYPE = 'custom';
            CONFIG.MUSIC_CONTENT.CUSTOM_URL = url;
            
            // é¡¯ç¤ºç•¶å‰é¸æ“‡
            showCurrentSelection(name);
            
            // é‡æ–°æ¸²æŸ“æœå°‹çµæœä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
            const query = document.getElementById('musicSearchInput').value;
            if (query.trim()) {
                const results = searchMusic(query);
                renderSearchResults(results);
            }
            
            // å¦‚æœæ­£åœ¨ç›£æ¸¬ä¸­ï¼Œåˆ‡æ›èƒŒæ™¯éŸ³æ¨‚
            if (isRecording) {
                switchBackgroundMusic(url);
            }
            
            // Google Analytics è¿½è¹¤
            if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.START_MONITORING) {
                trackEvent('music_selected', {
                    music_name: name,
                    music_category: category,
                    language: currentLanguage
                });
            }
        }

        // é¡¯ç¤ºç•¶å‰é¸æ“‡
        function showCurrentSelection(name) {
            const content = getLanguageContent();
            const container = document.getElementById('currentSelection');
            const label = document.getElementById('currentSelectionLabel');
            const nameElement = document.getElementById('currentSelectionName');
            
            label.textContent = content.labels.currentMusic;
            nameElement.textContent = name;
            container.style.display = 'block';
        }

        // åˆ‡æ›èƒŒæ™¯éŸ³æ¨‚
        function switchBackgroundMusic(url) {
            // åœæ­¢ç•¶å‰èƒŒæ™¯éŸ³æ¨‚
            if (backgroundAudioSource && backgroundGainNode) {
                backgroundGainNode.gain.exponentialRampToValueAtTime(
                    0.001, 
                    audioContext.currentTime + 1
                );
                setTimeout(() => {
                    if (backgroundAudioSource) {
                        backgroundAudioSource.stop();
                        backgroundAudioSource = null;
                        backgroundGainNode = null;
                    }
                }, 1000);
            }
            
            // è¼‰å…¥æ–°çš„èƒŒæ™¯éŸ³æ¨‚
            setTimeout(() => {
                if (url && isRecording) {
                    loadBackgroundAudio(url);
                }
            }, 1000);
        }

        // è‡ªå‹•åµæ¸¬ç”¨æˆ¶åœ°ç†ä½ç½®å’Œèªè¨€
        function detectUserLanguage() {
            return new Promise((resolve, reject) => {
                // å¦‚æœè¨­å®šç‚ºæ‰‹å‹•æŒ‡å®šèªè¨€ï¼Œç›´æ¥ä½¿ç”¨
                if (CONFIG.LANGUAGE !== 'auto') {
                    currentLanguage = CONFIG.LANGUAGE;
                    resolve(currentLanguage);
                    return;
                }

                // å¦‚æœæœªå•Ÿç”¨è‡ªå‹•èªè¨€åµæ¸¬ï¼Œä½¿ç”¨é è¨­èªè¨€
                if (!CONFIG.IPINFO.ENABLE_AUTO_LANGUAGE) {
                    currentLanguage = CONFIG.FALLBACK_LANGUAGE;
                    resolve(currentLanguage);
                    return;
                }

                // å»ºæ§‹ IPinfo API URL
                const apiUrl = CONFIG.IPINFO.API_TOKEN ? 
                    `https://ipinfo.io/json?token=${CONFIG.IPINFO.API_TOKEN}` : 
                    'https://ipinfo.io/json';

                // è¨­å®šè«‹æ±‚è¶…æ™‚
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.IPINFO.TIMEOUT);

                fetch(apiUrl, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                }).then(response => {
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`IPinfo API è«‹æ±‚å¤±æ•—: ${response.status}`);
                    }

                    return response.json();
                }).then(data => {
                    userCountry = data.country;

                    // æ ¹æ“šåœ‹å®¶ä»£ç¢¼æ˜ å°„èªè¨€
                    if (userCountry && COUNTRY_LANGUAGE_MAP[userCountry]) {
                        currentLanguage = COUNTRY_LANGUAGE_MAP[userCountry];
                    } else {
                        // å¦‚æœåœ‹å®¶ä»£ç¢¼ä¸åœ¨æ˜ å°„è¡¨ä¸­ï¼Œå˜—è©¦ä½¿ç”¨ç€è¦½å™¨èªè¨€
                        currentLanguage = getBrowserLanguage();
                    }

                    // Google Analytics è¿½è¹¤èªè¨€åµæ¸¬
                    if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.LANGUAGE_DETECTION) {
                        trackEvent('language_detection', {
                            detected_country: userCountry,
                            detected_language: currentLanguage,
                            detection_method: 'ipinfo_api',
                            browser_language: navigator.language
                        });
                    }

                    console.log(`ğŸŒ è‡ªå‹•åµæ¸¬èªè¨€: ${userCountry} -> ${currentLanguage}`);
                    resolve(currentLanguage);

                }).catch(error => {
                    clearTimeout(timeoutId);
                    console.warn('èªè¨€è‡ªå‹•åµæ¸¬å¤±æ•—:', error.message);
                    
                    // é™ç´šåˆ°ç€è¦½å™¨èªè¨€åµæ¸¬
                    currentLanguage = getBrowserLanguage();

                    // è¿½è¹¤åµæ¸¬å¤±æ•—äº‹ä»¶
                    if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.LANGUAGE_DETECTION) {
                        trackEvent('language_detection_failed', {
                            error_message: error.message,
                            fallback_language: currentLanguage,
                            detection_method: 'browser_language'
                        });
                    }
                    
                    resolve(currentLanguage);
                });
            });
        }

        // å¾ç€è¦½å™¨èªè¨€è¨­å®šæ¨æ–·èªè¨€
        function getBrowserLanguage() {
            const browserLang = navigator.language || navigator.languages[0] || CONFIG.FALLBACK_LANGUAGE;
            
            // è½‰æ›ç€è¦½å™¨èªè¨€ä»£ç¢¼ç‚ºæ‡‰ç”¨æ”¯æ´çš„èªè¨€
            if (browserLang.startsWith('zh')) {
                if (browserLang.includes('TW') || browserLang.includes('HK') || browserLang.includes('MO')) {
                    return 'zh-TW';
                } else {
                    return 'zh-CN';
                }
            } else if (browserLang.startsWith('ja')) {
                return 'ja';
            } else if (browserLang.startsWith('ko')) {
                return 'ko';
            } else if (browserLang.startsWith('en')) {
                return 'en';
            } else {
                return CONFIG.FALLBACK_LANGUAGE;
            }
        }

        // åˆå§‹åŒ– Google Analytics
        function initGoogleAnalytics() {
            if (!CONFIG.GOOGLE_ANALYTICS.ENABLE_TRACKING || !CONFIG.GOOGLE_ANALYTICS.GA_ID || gaInitialized) {
                return;
            }

            // è¼‰å…¥ GA4 è…³æœ¬
            const script1 = document.createElement('script');
            script1.async = true;
            script1.src = `https://www.googletagmanager.com/gtag/js?id=${CONFIG.GOOGLE_ANALYTICS.GA_ID}`;
            document.head.appendChild(script1);

            // åˆå§‹åŒ– GA4
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            window.gtag = gtag;
            gtag('js', new Date());
            gtag('config', CONFIG.GOOGLE_ANALYTICS.GA_ID);

            gaInitialized = true;
        }

        // ç™¼é€ GA äº‹ä»¶
        function trackEvent(eventName, parameters = {}) {
            if (!CONFIG.GOOGLE_ANALYTICS.ENABLE_TRACKING || !window.gtag) {
                return;
            }

            window.gtag('event', eventName, {
                event_category: 'binaural_beats',
                ...parameters
            });
        }

        // ç²å–ç•¶å‰èªè¨€å…§å®¹
        function getLanguageContent() {
            return LANGUAGE_CONTENT[currentLanguage] || LANGUAGE_CONTENT['zh-TW'];
        }

        // æ›´æ–°é é¢èªè¨€å…§å®¹
        function updateLanguageContent() {
            const content = getLanguageContent();
            
            // æ›´æ–°ä¸»è¦æ¨™é¡Œ
            document.querySelector('h1').textContent = content.title;
            document.querySelector('.adaptive-mode h3').textContent = content.subtitle;
            document.querySelector('.adaptive-mode p').textContent = content.description;
            
            // æ›´æ–°ç‹€æ…‹æè¿°
            const listItems = document.querySelectorAll('.adaptive-mode li');
            listItems[0].innerHTML = `<strong>${content.states.deep_relaxed}</strong> ${content.stateDescriptions.deep_relaxed}`;
            listItems[1].innerHTML = `<strong>${content.states.relaxed}</strong> ${content.stateDescriptions.relaxed}`;
            listItems[2].innerHTML = `<strong>${content.states.normal}</strong> ${content.stateDescriptions.normal}`;
            listItems[3].innerHTML = `<strong>${content.states.tense}</strong> ${content.stateDescriptions.tense}`;
            
            // æ›´æ–°é…ç½®å€åŸŸ
            document.getElementById('systemConfigTitle').textContent = content.labels.systemConfig;
            document.getElementById('audioSearchTitle').textContent = content.labels.audioSearch;
            
            // æ›´æ–°æœå°‹æ¡†ä½”ä½ç¬¦
            document.getElementById('musicSearchInput').placeholder = content.labels.searchPlaceholder;
            
            // æ›´æ–°è¨­å‚™æ¸¬è©¦æŒ‰éˆ•
            document.getElementById('deviceTestBtn').innerHTML = `ğŸ¤ ${content.labels.deviceTest}`;
            
            // æ›´æ–°æ¨™ç±¤
            document.querySelector('.breath-visual h3').textContent = content.labels.breathVisual;
            document.querySelector('.breath-stats h3').textContent = content.labels.realTimeData;
            
            // æ›´æ–°çµ±è¨ˆæ¨™ç±¤
            document.querySelectorAll('.stat-label')[0].textContent = content.labels.breathRate;
            document.querySelectorAll('.stat-label')[1].textContent = content.labels.currentState;
            document.querySelectorAll('.stat-label')[2].textContent = content.labels.brainwave;
            
            // æ›´æ–°æŒ‰éˆ•
            document.getElementById('startAdaptiveBtn').textContent = content.buttons.start;
            document.getElementById('stopAdaptiveBtn').textContent = content.buttons.stop;
            
            // é‡ç½®çµ±è¨ˆé¡¯ç¤º
            resetStatsDisplay();
        }

        // é‡ç½®çµ±è¨ˆé¡¯ç¤º
        function resetStatsDisplay() {
            const content = getLanguageContent();
            document.getElementById('breathRate').textContent = `-- ${content.units.perMin}`;
            document.getElementById('currentState').textContent = content.status.waiting;
            document.getElementById('brainwaveType').textContent = '--';
        }

        // ç²å–èƒŒæ™¯éŸ³æª”URL
        function getBackgroundAudioUrl() {
            if (CONFIG.MUSIC_CONTENT.TYPE === 'custom') {
                return CONFIG.MUSIC_CONTENT.CUSTOM_URL;
            }
            
            const musicList = MUSIC_LIBRARY[CONFIG.MUSIC_CONTENT.TYPE];
            if (musicList && musicList.length > 0) {
                // éš¨æ©Ÿé¸æ“‡ä¸€é¦–éŸ³æ¨‚
                const randomIndex = Math.floor(Math.random() * musicList.length);
                return musicList[randomIndex].url;
            }
            
            return '';
        }

        // åˆå§‹åŒ–é…ç½®é¡¯ç¤º
        function initConfigDisplay() {
            const content = getLanguageContent();
            const audioUrl = getBackgroundAudioUrl();
            
            document.getElementById('configBaseFreq').textContent = `${CONFIG.BASE_FREQUENCY} ${content.units.hz}`;
            
            // é¡¯ç¤ºéŸ³æ¨‚é¡å‹å’Œåœ‹å®¶è³‡è¨Š
            let audioInfo = content.units.none;
            if (audioUrl) {
                if (CONFIG.MUSIC_CONTENT.TYPE === 'custom') {
                    audioInfo = audioUrl.split('/').pop();
                } else {
                    audioInfo = CONFIG.MUSIC_CONTENT.TYPE;
                }
            }
            
            // å¦‚æœæœ‰åµæ¸¬åˆ°åœ‹å®¶ï¼Œé¡¯ç¤ºåœ‹å®¶è³‡è¨Š
            if (userCountry) {
                audioInfo += ` (${userCountry})`;
            }
            
            document.getElementById('configAudioFile').textContent = audioInfo;
        }

        // é¡¯ç¤ºèªè¨€åµæ¸¬ç‹€æ…‹
        function showLanguageDetectionStatus() {
            const content = getLanguageContent();
            let statusMessage = '';
            
            if (CONFIG.LANGUAGE === 'auto') {
                if (userCountry) {
                    statusMessage = `ğŸŒ å·²è‡ªå‹•åµæ¸¬: ${userCountry} â†’ ${currentLanguage}`;
                } else {
                    statusMessage = `ğŸŒ ä½¿ç”¨ç€è¦½å™¨èªè¨€: ${currentLanguage}`;
                }
            } else {
                statusMessage = `âš™ï¸ æ‰‹å‹•è¨­å®šèªè¨€: ${currentLanguage}`;
            }
            
            // åœ¨ç‹€æ…‹å€åŸŸé¡¯ç¤ºèªè¨€åµæ¸¬çµæœ
            const tempStatus = document.createElement('div');
            tempStatus.className = 'status success';
            tempStatus.style.fontSize = '14px';
            tempStatus.style.padding = '10px';
            tempStatus.style.marginBottom = '15px';
            tempStatus.textContent = statusMessage;
            
            const container = document.querySelector('.container');
            const configInfo = document.querySelector('.config-info');
            container.insertBefore(tempStatus, configInfo.nextSibling);
            
            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (tempStatus.parentNode) {
                    tempStatus.parentNode.removeChild(tempStatus);
                }
            }, 3000);
        }

        // åˆå§‹åŒ– Web Audio API
        function initAudioContext() {
            return new Promise((resolve, reject) => {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        resolve();
                    }).catch(reject);
                } else {
                    resolve();
                }
            });
        }

        // é–‹å§‹æ™ºèƒ½å‘¼å¸ç›£æ¸¬æ¨¡å¼
        function startAdaptiveMode() {
            initAudioContext().then(() => {
                // Google Analytics è¿½è¹¤
                if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.START_MONITORING) {
                    trackEvent('start_monitoring', {
                        language: currentLanguage,
                        music_type: CONFIG.MUSIC_CONTENT.TYPE
                    });
                }
                
                // å–å¾—éº¥å…‹é¢¨æ¬Šé™
                return navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: CONFIG.SAMPLE_RATE,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
            }).then(stream => {
                mediaStream = stream;
                
                // è¨­ç½®éŸ³è¨Šåˆ†æ
                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                
                source.connect(analyser);
                
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                isRecording = true;
                
                // å•Ÿå‹•å‘¼å¸æª¢æ¸¬
                startBreathDetection();
                
                // ç”Ÿæˆåˆå§‹æ‹é »
                startBinauralBeats();
                
                // è¼‰å…¥èƒŒæ™¯éŸ³æª”ï¼ˆå¦‚æœæœ‰é…ç½®ï¼‰
                const audioUrl = getBackgroundAudioUrl();
                if (audioUrl) {
                    loadBackgroundAudio(audioUrl);
                }
                
                document.getElementById('startAdaptiveBtn').disabled = true;
                document.getElementById('stopAdaptiveBtn').disabled = false;
                
                const content = getLanguageContent();
                showStatus(content.status.monitoring, 'processing');
                
            }).catch(error => {
                console.error('å•Ÿå‹•å¤±æ•—:', error);
                const content = getLanguageContent();
                showStatus(`${content.status.error}${error.message}`, 'error');
            });
        }

        // åœæ­¢æ™ºèƒ½æ¨¡å¼
        function stopAdaptiveMode() {
            isRecording = false;
            
            // Google Analytics è¿½è¹¤
            if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.STOP_MONITORING) {
                trackEvent('stop_monitoring', {
                    language: currentLanguage
                });
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            
            // åœæ­¢æ‹é »
            stopBinauralBeats();
            
            // åœæ­¢èƒŒæ™¯éŸ³æ¨‚ï¼ˆå¸¶æ·¡å‡ºæ•ˆæœï¼‰
            if (backgroundAudioSource && backgroundGainNode) {
                const fadeOutDuration = CONFIG.MUSIC_CONTENT.FADE_OUT_DURATION;
                backgroundGainNode.gain.exponentialRampToValueAtTime(
                    0.001, 
                    audioContext.currentTime + fadeOutDuration
                );
                setTimeout(() => {
                    if (backgroundAudioSource) {
                        backgroundAudioSource.stop();
                        backgroundAudioSource = null;
                        backgroundGainNode = null;
                    }
                }, fadeOutDuration * 1000);
            }
            
            document.getElementById('startAdaptiveBtn').disabled = false;
            document.getElementById('stopAdaptiveBtn').disabled = true;
            
            // é‡ç½®çµ±è¨ˆé¡¯ç¤º
            resetStatsDisplay();
            
            const content = getLanguageContent();
            showStatus(content.status.stopped, 'success');
        }                startBinauralBeats();
                
                // è¼‰å…¥èƒŒæ™¯éŸ³æª”ï¼ˆå¦‚æœæœ‰é…ç½®ï¼‰
                const audioUrl = getBackgroundAudioUrl();
                if (audioUrl) {
                    await loadBackgroundAudio(audioUrl);
                }
                
                document.getElementById('startAdaptiveBtn').disabled = true;
                document.getElementById('stopAdaptiveBtn').disabled = false;
                
                const content = getLanguageContent();
                showStatus(content.status.monitoring, 'processing');
                
            } catch (error) {
                console.error('å•Ÿå‹•å¤±æ•—:', error);
                const content = getLanguageContent();
                showStatus(`${content.status.error}${error.message}`, 'error');
            }
        }

        // åœæ­¢æ™ºèƒ½æ¨¡å¼
        function stopAdaptiveMode() {
            isRecording = false;
            
            // Google Analytics è¿½è¹¤
            if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.STOP_MONITORING) {
                trackEvent('stop_monitoring', {
                    language: currentLanguage
                });
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            
            // åœæ­¢æ‹é »
            stopBinauralBeats();
            
            // åœæ­¢èƒŒæ™¯éŸ³æ¨‚ï¼ˆå¸¶æ·¡å‡ºæ•ˆæœï¼‰
            if (backgroundAudioSource && backgroundGainNode) {
                const fadeOutDuration = CONFIG.MUSIC_CONTENT.FADE_OUT_DURATION;
                backgroundGainNode.gain.exponentialRampToValueAtTime(
                    0.001, 
                    audioContext.currentTime + fadeOutDuration
                );
                setTimeout(() => {
                    if (backgroundAudioSource) {
                        backgroundAudioSource.stop();
                        backgroundAudioSource = null;
                        backgroundGainNode = null;
                    }
                }, fadeOutDuration * 1000);
            }
            
            document.getElementById('startAdaptiveBtn').disabled = false;
            document.getElementById('stopAdaptiveBtn').disabled = true;
            document.getElementById('breathCircle').classList.remove('breathing');
            
            // é‡ç½®çµ±è¨ˆé¡¯ç¤º
            resetStatsDisplay();
            
            const content = getLanguageContent();
            showStatus(content.status.stopped, 'success');
        }

        // UI è¼”åŠ©å‡½æ•¸
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        // å‘¼å¸æª¢æ¸¬
        function startBreathDetection() {
            const canvas = document.getElementById('waveform');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            let breathingSamples = [];
            let lastBreathTime = Date.now();
            let breathCount = 0;
            
            function detectBreath() {
                if (!isRecording) return;
                
                analyser.getByteTimeDomainData(dataArray);
                
                // è¨ˆç®—èƒ½é‡
                let energy = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    const sample = (dataArray[i] - 128) / 128;
                    energy += sample * sample;
                }
                energy = Math.sqrt(energy / dataArray.length);
                
                breathingSamples.push(energy);
                if (breathingSamples.length > 300) { // ä¿æŒç´„10ç§’çš„æ•¸æ“š
                    breathingSamples.shift();
                }
                
                // ç¹ªè£½æ³¢å½¢
                drawWaveform(ctx, canvas, breathingSamples);
                
                // æª¢æ¸¬å‘¼å¸å³°å€¼
                if (breathingSamples.length > 10) {
                    const recent = breathingSamples.slice(-10);
                    const avgEnergy = recent.reduce((a, b) => a + b) / recent.length;
                    const threshold = Math.max(...breathingSamples) * CONFIG.BREATH_DETECTION_SENSITIVITY;
                    
                    if (energy > threshold && energy > avgEnergy * 1.5) {
                        const now = Date.now();
                        if (now - lastBreathTime > 1000) { // è‡³å°‘1ç§’é–“éš”
                            breathCount++;
                            lastBreathTime = now;
                            
                            // å‘¼å¸è¦–è¦ºåŒ–å·²ç§»é™¤ï¼Œä¸éœ€è¦å‹•ç•«
                        }
                        }
                    }
                }
                
                // æ¯5ç§’è¨ˆç®—ä¸€æ¬¡å‘¼å¸é€Ÿç‡
                if (breathingSamples.length % 150 === 0) {
                    const breathRate = (breathCount / (breathingSamples.length / 30)) * 60;
                    updateBreathingStats(breathRate);
                    breathCount = Math.floor(breathCount * 0.8); // è¡°æ¸›èˆŠæ•¸æ“š
                }
                
                requestAnimationFrame(detectBreath);
            }
            
            detectBreath();
        }

        // ç¹ªè£½æ³¢å½¢
        function drawWaveform(ctx, canvas, samples) {
            // æ¸…é™¤ç•«å¸ƒ
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç¹ªè£½ä¸­ç·š
            ctx.strokeStyle = '#dee2e6';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
            
            // ç¹ªè£½æ³¢å½¢
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const sliceWidth = canvas.width / samples.length;
            let x = 0;
            
            for (let i = 0; i < samples.length; i++) {
                const y = (samples[i] * canvas.height / 2) + canvas.height / 2;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.stroke();
        }

        // æ›´æ–°å‘¼å¸çµ±è¨ˆ
        function updateBreathingStats(breathRate) {
            const content = getLanguageContent();
            document.getElementById('breathRate').textContent = `${breathRate.toFixed(1)} ${content.units.perMin}`;
            
            let state, beatFreq, brainwave, stateKey;
            
            if (breathRate < 10) {
                state = content.states.deep_relaxed;
                stateKey = 'deep_relaxed';
                brainwave = content.waves.delta;
            } else if (breathRate < 15) {
                state = content.states.relaxed;
                stateKey = 'relaxed';
                brainwave = content.waves.theta;
            } else if (breathRate < 20) {
                state = content.states.normal;
                stateKey = 'normal';
                brainwave = content.waves.alpha;
            } else {
                state = content.states.tense;
                stateKey = 'tense';
                brainwave = content.waves.beta;
            }
            
            beatFreq = BEAT_FREQUENCY_MAP[stateKey];
            
            document.getElementById('currentState').textContent = state;
            document.getElementById('brainwaveType').textContent = brainwave;
            
            // æ›´æ–°æ‹é »
            if (beatFreq !== currentBeatFreq) {
                // Google Analytics è¿½è¹¤ç‹€æ…‹è®ŠåŒ–
                if (CONFIG.GOOGLE_ANALYTICS.TRACK_EVENTS.BREATH_STATE_CHANGE) {
                    trackEvent('breath_state_change', {
                        from_state: currentBeatFreq,
                        to_state: beatFreq,
                        state_name: stateKey,
                        breath_rate: breathRate,
                        language: currentLanguage
                    });
                }
                
                currentBeatFreq = beatFreq;
                updateBinauralBeats(beatFreq);
            }
        }

        // ç”Ÿæˆæ‹é »éŸ³è¨Š
        function startBinauralBeats() {
            // å·¦è€³æŒ¯ç›ªå™¨
            const leftOsc = audioContext.createOscillator();
            const leftGain = audioContext.createGain();
            leftOsc.type = 'sine';
            leftOsc.frequency.setValueAtTime(CONFIG.BASE_FREQUENCY, audioContext.currentTime);
            leftGain.gain.setValueAtTime(CONFIG.BINAURAL_VOLUME, audioContext.currentTime);
            
            // å³è€³æŒ¯ç›ªå™¨  
            const rightOsc = audioContext.createOscillator();
            const rightGain = audioContext.createGain();
            rightOsc.type = 'sine';
            rightOsc.frequency.setValueAtTime(CONFIG.BASE_FREQUENCY + currentBeatFreq, audioContext.currentTime);
            rightGain.gain.setValueAtTime(CONFIG.BINAURAL_VOLUME, audioContext.currentTime);
            
            // ç«‹é«”è²åˆ†é›¢
            const merger = audioContext.createChannelMerger(2);
            leftOsc.connect(leftGain).connect(merger, 0, 0);
            rightOsc.connect(rightGain).connect(merger, 0, 1);
            merger.connect(audioContext.destination);
            
            leftOsc.start();
            rightOsc.start();
            
            binauralOscillators = [leftOsc, rightOsc, leftGain, rightGain, merger];
        }

        // æ›´æ–°æ‹é »é »ç‡
        function updateBinauralBeats(newBeatFreq) {
            if (binauralOscillators.length > 0) {
                const rightOsc = binauralOscillators[1];
                rightOsc.frequency.setValueAtTime(CONFIG.BASE_FREQUENCY + newBeatFreq, audioContext.currentTime);
            }
        }

        // åœæ­¢æ‹é »
        function stopBinauralBeats() {
            binauralOscillators.forEach(node => {
                if (node.stop) {
                    node.stop();
                } else if (node.disconnect) {
                    node.disconnect();
                }
            });
            binauralOscillators = [];
        }

        // è¼‰å…¥èƒŒæ™¯éŸ³æª”
        function loadBackgroundAudio(url) {
            fetch(url).then(response => {
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è¼‰å…¥èƒŒæ™¯éŸ³æª”ï¼š${response.statusText}`);
                }
                return response.arrayBuffer();
            }).then(arrayBuffer => {
                return audioContext.decodeAudioData(arrayBuffer);
            }).then(audioBuffer => {
                backgroundAudioSource = audioContext.createBufferSource();
                backgroundGainNode = audioContext.createGain();
                
                backgroundAudioSource.buffer = audioBuffer;
                backgroundAudioSource.loop = CONFIG.MUSIC_CONTENT.LOOP;
                
                // è¨­ç½®æ·¡å…¥æ•ˆæœ
                const fadeInDuration = CONFIG.MUSIC_CONTENT.FADE_IN_DURATION;
                backgroundGainNode.gain.setValueAtTime(0, audioContext.currentTime);
                backgroundGainNode.gain.exponentialRampToValueAtTime(
                    CONFIG.BACKGROUND_VOLUME, 
                    audioContext.currentTime + fadeInDuration
                );
                
                backgroundAudioSource.connect(backgroundGainNode).connect(audioContext.destination);
                backgroundAudioSource.start();
            }).catch(error => {
                console.warn('èƒŒæ™¯éŸ³æª”è¼‰å…¥å¤±æ•—:', error);
            });
        }

        // è¨­å‚™æ¸¬è©¦åŠŸèƒ½
        function testDevice() {
            const btn = document.getElementById('deviceTestBtn');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = 'ğŸ”„ æ¸¬è©¦ä¸­...';
            
            // æ¸¬è©¦éº¥å…‹é¢¨
            navigator.mediaDevices.getUserMedia({ 
                audio: {
                    sampleRate: 16000,
                    channelCount: 1
                } 
            }).then(stream => {
                // ç°¡å–®æ¸¬è©¦éŸ³è¨Šè¼¸å…¥
                const testContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = testContext.createMediaStreamSource(stream);
                const testAnalyser = testContext.createAnalyser();
                source.connect(testAnalyser);
                
                const bufferLength = testAnalyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                // æ¸¬è©¦3ç§’
                let maxVolume = 0;
                const testDuration = 3000;
                const startTime = Date.now();
                
                const testInterval = setInterval(() => {
                    testAnalyser.getByteTimeDomainData(dataArray);
                    
                    let volume = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        const sample = Math.abs(dataArray[i] - 128);
                        volume = Math.max(volume, sample);
                    }
                    
                    maxVolume = Math.max(maxVolume, volume);
                    
                    if (Date.now() - startTime > testDuration) {
                        clearInterval(testInterval);
                        stream.getTracks().forEach(track => track.stop());
                        testContext.close();
                        
                        // é¡¯ç¤ºæ¸¬è©¦çµæœ
                        if (maxVolume > 10) {
                            btn.innerHTML = 'âœ… è¨­å‚™æ­£å¸¸';
                            btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                        } else {
                            btn.innerHTML = 'âš ï¸ éŸ³é‡éä½';
                            btn.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
                        }
                        
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                            btn.disabled = false;
                        }, 2000);
                    }
                }, 100);
                
            }).catch(error => {
                console.error('è¨­å‚™æ¸¬è©¦å¤±æ•—:', error);
                btn.innerHTML = 'âŒ æ¸¬è©¦å¤±æ•—';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    btn.disabled = false;
                }, 2000);
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–éŸ³æ¨‚åº«
            initMusicLibrary();
            
            // åˆå§‹åŒ– Google Analytics
            initGoogleAnalytics();
            
            // è‡ªå‹•åµæ¸¬ç”¨æˆ¶èªè¨€
            detectUserLanguage().then(() => {
                // æ›´æ–°èªè¨€å…§å®¹
                updateLanguageContent();
                
                // åˆå§‹åŒ–é…ç½®é¡¯ç¤º
                initConfigDisplay();
                
                // é¡¯ç¤ºèªè¨€åµæ¸¬ç‹€æ…‹
                showLanguageDetectionStatus();
            }).catch(error => {
                console.error('èªè¨€åµæ¸¬å¤±æ•—:', error);
                // ä½¿ç”¨é è¨­èªè¨€
                updateLanguageContent();
                initConfigDisplay();
            });
            
            // è¨­ç½®æœå°‹æ¡†äº‹ä»¶
            const searchInput = document.getElementById('musicSearchInput');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                if (query.trim()) {
                    const results = searchMusic(query);
                    renderSearchResults(results);
                } else {
                    document.getElementById('searchResults').style.display = 'none';
                }
            });

            // é é¢é—œé–‰æ™‚æ¸…ç†è³‡æº
            window.addEventListener('beforeunload', () => {
                if (isRecording) {
                    stopAdaptiveMode();
                }
            });

            // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                const content = getLanguageContent();
                showStatus(content.status.unsupported, 'error');
                document.getElementById('startAdaptiveBtn').disabled = true;
                document.getElementById('deviceTestBtn').disabled = true;
            }
        });
    </script>
</body>
</html>
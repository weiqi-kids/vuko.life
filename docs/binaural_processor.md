# binaural_processor.js 核心演算法說明

本文件詳細說明 `js/binaural_processor.js` 之核心功能、資料結構，以及運作公式。

`binaural_processor.js` 負責處理動態拍頻音效的生成與呼吸偵測推論，  
根據使用者實時呼吸頻率與目標頻率，自動調整導引聲音的拍頻、音量與背景音比例，  
同時因應收音環境動態調節參數與發出警告訊息。

---

## 目錄

1. [輸入參數（Input）](#輸入參數input)
2. [輸出參數（Output）](#輸出參數output)
3. [核心運作公式（Core Logic）](#核心運作公式core-logic)
4. [補充與注意事項](#補充與注意事項)

---

## 輸入參數（Input）

### 一、基礎呼吸與背景訊號（從麥克風音源來）

| 參數名稱             | 類型           | 說明                 | 範例                 |
| ---------------- | ------------ | ------------------ | ------------------ |
| B\_user\_raw     | array<float> | 原始呼吸訊號時間序列         | \[0.01, 0.05, ...] |
| B\_user          | float        | 即時呼吸頻率（Hz 或 BPM）   | 0.25               |
| B\_user\_quality | float        | 呼吸偵測品質分數（0\~1）     | 0.93               |
| B\_user\_stable  | bool         | 呼吸頻率是否穩定           | true               |
| S\_breath\_raw   | array<float> | 呼吸聲原始波形資料          | \[0.01, 0.05, ...] |
| N\_bg\_level     | float        | 背景噪音強度（0\~1）       | 0.35               |
| N\_bg\_freq      | array<float> | 背景噪音主頻分佈（Hz）       | \[0.20, 0.50, ...] |
| N\_bg\_quality   | float        | 收音品質評分（0\~1）       | 0.88               |
| N\_bg\_corr      | float        | 呼吸訊號與背景噪音相關性（0\~1） | 0.25               |

---

### 二、目標頻率與引導設定（從選擇音檔來）

| 參數名稱                  | 類型           | 說明                | 範例                     |
| --------------------- | ------------ | ----------------- | ---------------------- |
| B\_target             | float        | 目標呼吸頻率（Hz 或 BPM）  | 0.20                   |
| target\_curve         | array<float> | 進階模式下目標頻率曲線       | \[0.22, 0.21, 0.20...] |
| context.mode          | string       | 當前情境模式            | "relax"                |
| context.music\_type   | string       | 音樂/導引音類型          | "binaural"             |
| context.base\_freq    | float        | 基礎導引音頻率（Hz）       | 528                    |
| context.bg\_type      | string       | 背景音類型             | "forest"               |
| context.bg\_weight    | float        | 背景音音量比例（0\~1）     | 0.4                    |
| context.threshold     | float        | 偏離啟動導引門檻（Hz）      | 0.03                   |
| context.max\_diff     | float        | 最大偏離容忍值           | 0.15                   |
| context.accept\_range | array<float> | 可接受的目標頻率範圍        | \[0.18, 0.22]          |

---

## 輸出參數（Output）

| 參數名   | 類型         | 說明                                                     | 範例                      |
|----------|--------------|----------------------------------------------------------|---------------------------|
| `F_beat` | float        | 推薦導引音拍頻（Hz）                                     | 0.22                      |
| `V`      | float        | 導引音音量（0~1）                                        | 0.65                      |
| `R_bg`   | float        | 背景音權重（0~1，值大代表環境音比重高）                  | 0.4                       |
| `F_base` | float        | 建議的基礎頻率（Hz，依據所選音樂類型/情境）              | 528                       |
| `warning`| string/null  | 噪音或偵測警告訊息，如有異常會提供建議                  | "高噪音，請靠近麥克風"    |
| `log`    | object       | 除錯或分析用的參數記錄                                   | {"delta_b": 0.05, ...}    |

---

## 核心邏輯（Core Logic）

---

## 設備、用戶資訊、歷史與回饋紀錄（用戶自願參與 Flywheel）

本系統支援紀錄裝置資訊、使用者標識、平台來源，並可選擇性保存個人呼吸歷史及體驗回饋（Flywheel）。
這些資料**完全尊重用戶意願與隱私**，主要用於：
- 幫助用戶追蹤自身呼吸/專注訓練成效
- 協助系統自動優化參數、個人化推薦
- 用於匿名性統計分析與功能迭代

| 參數名稱       | 類型           | 說明                                               | 範例                    |
| -------------- | -------------- | -------------------------------------------------- | ---------------------- |
| device_label   | string         | 收音裝置名稱（僅於用戶授權下取得）                  | "iPhoneMic_1"          |
| user_id        | string         | 用戶唯一識別（僅於登入/授權時產生，保障匿名性）      | "u123456"              |
| platform       | string         | 執行平台/版本（如 Web、iOS、Android）               | "web"                  |
| history        | object/array   | 過往呼吸、偏離、音量等紀錄（用戶可選擇開啟/關閉）     | [{...}, {...}]         |
| feedback       | object         | 用戶自願回饋（自評分、問卷、意見建議等）             | {"guide_effect": 4}    |

> 歷史資料與回饋紀錄均採「用戶自主回報」，可隨時啟用/停用，**所有資料僅用於功能優化，不作為商業用途或對外公開。**

---

## 補充與注意事項

